<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas</title>
    <style>
        /* æ²‰æµ¸é»‘åº• */
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; height: 100%; font-family: sans-serif; touch-action: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; cursor: grab; }
        canvas:active { cursor: grabbing; }

        /* UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* å¯åŠ¨é¡µ */
        #start-screen {
            pointer-events: auto;
            background: rgba(0,0,0,0.8);
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s;
            position: absolute; top: 0; left: 0; z-index: 200;
            backdrop-filter: blur(10px);
        }

        .btn-play {
            padding: 18px 60px;
            font-size: 1.5rem;
            color: #fff;
            background: linear-gradient(135deg, #ff0055, #ffcc00);
            border: none; border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.8);
            font-weight: bold; letter-spacing: 2px;
            animation: pulse 1.2s infinite alternate;
        }
        @keyframes pulse { from { transform: scale(1); box-shadow: 0 0 20px rgba(255,0,85,0.5); } to { transform: scale(1.05); box-shadow: 0 0 50px rgba(255,0,85,1); } }

        /* æ“ä½œæç¤º */
        .hint-text {
            color: rgba(255,255,255,0.6); font-size: 14px; margin-top: 20px;
            animation: fadeInOut 2s infinite;
        }
        @keyframes fadeInOut { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* å­—å¹• */
        #subtitle {
            position: absolute; bottom: 20%; width: 100%; text-align: center;
            color: #fff; font-size: 1.4rem; font-weight: bold;
            text-shadow: 0 0 10px #fff; opacity: 0; transition: opacity 0.5s;
        }

        /* æœ€ç»ˆç¥ç¦ (åº•éƒ¨) */
        #final-msg {
            position: absolute; bottom: 8%; width: 100%; text-align: center;
            opacity: 0; transition: opacity 2s; pointer-events: none; z-index: 300;
        }
        .msg-title {
            font-size: 3.5rem; color: #FFD700; font-weight: bold; margin-bottom: 5px;
            text-shadow: 0 0 30px #FFD700; font-family: serif;
        }
        .msg-body {
            font-size: 1.4rem; color: #fff; font-weight: bold; text-shadow: 0 2px 5px #000;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="start-screen">
        <button class="btn-play" onclick="startShow()">ğŸ ç‚¹äº®æ˜Ÿæ²³</button>
        <div class="hint-text">ğŸ‘ˆ å·¦å³æ»‘åŠ¨å±å¹• æ—‹è½¬è§†è§’ ğŸ‘‰</div>
    </div>
    <div id="subtitle"></div>
    <div id="final-msg">
        <div class="msg-title">Merry Christmas</div>
        <div class="msg-body">è€å©†ï¼Œåœ£è¯å¿«ä¹ â¤ï¸</div>
    </div>
</div>

<canvas id="canvas"></canvas>
<audio id="bgm" loop>
    <source src="https://music.163.com/song/media/outer/url?id=1901371647.mp3" type="audio/mpeg">
</audio>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const subtitle = document.getElementById('subtitle');
    
    let width, height;
    let particles = [];
    let fireworks = [];
    let isPlaying = false;
    let startTime = 0;

    // --- äº¤äº’æ§åˆ¶å˜é‡ ---
    let autoRotateSpeed = 0.002;
    let targetRotation = 0;
    let currentRotation = 0;
    let isDragging = false;
    let lastX = 0;
    
    // å¢åŠ ç²’å­æ•°ï¼Œå¢å¼ºâ€œç²’å­äº‘â€çš„æ„Ÿè§‰
    const PARTICLE_COUNT = 3500; 
    
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // ==========================================
    //           3D äº¤äº’é€»è¾‘ (Touch & Mouse)
    // ==========================================
    function handleStart(x) {
        isDragging = true;
        lastX = x;
        autoRotateSpeed = 0; // æ‰‹æŒ‡æŒ‰ä½æ—¶åœæ­¢è‡ªåŠ¨æ—‹è½¬
    }
    function handleMove(x) {
        if (!isDragging) return;
        const delta = x - lastX;
        targetRotation += delta * 0.005; // çµæ•åº¦
        lastX = x;
    }
    function handleEnd() {
        isDragging = false;
        // æ¢å¤ç¼“æ…¢çš„è‡ªåŠ¨æ—‹è½¬ (æ–¹å‘è·Ÿéšæ‰‹æŒ‡)
        autoRotateSpeed = 0.001; 
    }

    // è§¦æ‘¸äº‹ä»¶
    canvas.addEventListener('touchstart', e => handleStart(e.touches[0].clientX));
    canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX); });
    canvas.addEventListener('touchend', handleEnd);
    // é¼ æ ‡äº‹ä»¶
    canvas.addEventListener('mousedown', e => handleStart(e.clientX));
    canvas.addEventListener('mousemove', e => handleMove(e.clientX));
    canvas.addEventListener('mouseup', handleEnd);

    // ==========================================
    //           æ ¸å¿ƒç²’å­ç³»ç»Ÿ (True 3D)
    // ==========================================
    class Particle {
        constructor() {
            this.reset(true);
        }

        reset(isInit = false) {
            // å®šä¹‰æ ‘çš„å‡ ä½•å½¢çŠ¶
            this.h = Math.random(); 
            
            // æ ‘é«˜å‚æ•°
            const treeH = 1000; // æ ‘çš„é«˜åº¦
            const bottomY = 400; // æ ‘åº•åœ¨å±å¹•çš„ä½ç½®
            
            // ç›®æ ‡ Y (ä¸–ç•Œåæ ‡)
            this.ty = bottomY - this.h * treeH;

            // ç›®æ ‡ X, Z (åœ†é”¥ä½“)
            // ä½¿ç”¨ sqrt å¡«å……å†…éƒ¨ï¼Œpowè°ƒæ•´å½¢çŠ¶è®©åº•éƒ¨æ›´é¥±æ»¡
            const maxR = 350 * Math.pow(1 - this.h, 0.6);
            const r = maxR * Math.sqrt(Math.random()); 
            const angle = Math.random() * Math.PI * 2;
            
            this.tx = Math.cos(angle) * r;
            this.tz = Math.sin(angle) * r;

            // ç²’å­ç±»å‹
            const rand = Math.random();
            if (rand < 0.15) { // æ ‘å¹² (ä¸­å¿ƒåœ†æŸ±)
                this.type = 'trunk';
                const trunkH = Math.random();
                this.ty = bottomY - trunkH * (treeH * 0.3); // æ ‘å¹²åªåœ¨ä¸‹éƒ¨
                const trunkR = 30 * Math.sqrt(Math.random());
                this.tx = Math.cos(angle) * trunkR;
                this.tz = Math.sin(angle) * trunkR;
                this.color = `hsla(${30+Math.random()*10}, 60%, 40%, 1)`;
                this.size = 2;
            } else if (rand < 0.25) { // éœ“è™¹ç¯
                this.type = 'light';
                this.color = Math.random() > 0.5 ? '#FFD700' : `hsl(${Math.random()*360}, 100%, 70%)`;
                this.size = 3.5;
                this.blinkOffset = Math.random() * 100;
            } else { // ç²’å­å¶
                this.type = 'leaf';
                // é¢œè‰²æ¸å˜ï¼šä¸Šå«©ä¸‹æ·±
                const hue = 120 + Math.random() * 40;
                const light = 30 + this.h * 40;
                this.color = `hsla(${hue}, 80%, ${light}%, 1)`;
                this.size = 1.8;
            }

            // åˆå§‹å¤§çˆ†ç‚¸ä½ç½® (å±å¹•å¤–)
            if (isInit) {
                const startR = 1500;
                const startTheta = Math.random() * Math.PI * 2;
                const startPhi = Math.random() * Math.PI;
                this.x = startR * Math.sin(startPhi) * Math.cos(startTheta);
                this.y = startR * Math.sin(startPhi) * Math.sin(startTheta);
                this.z = startR * Math.cos(startPhi);
            } else {
                this.x = this.tx; this.y = this.ty; this.z = this.tz;
            }
        }

        update(timeline) {
            // 1. æ±‡èšåŠ¨ç”» (å‰8ç§’)
            if (timeline < 8000) {
                const p = timeline / 8000;
                // ç¼“åŠ¨å‡½æ•°
                const ease = p * p * (3 - 2 * p);
                
                // ä»åˆå§‹ä½ç½®é£å‘ç›®æ ‡ (å¸¦èºæ—‹)
                const currentY = this.y + (this.ty - this.y) * 0.1; // Yè½´å¸é™„å¿«ä¸€ç‚¹
                
                // èºæ—‹åŠå¾„æ”¶ç¼©
                const rFactor = 1 - ease;
                const spiralR = 800 * rFactor;
                const spin = (1-ease) * 10;
                
                // ç›®æ ‡ä½ç½®
                const targetX = this.tx;
                const targetZ = this.tz;
                
                // æ··åˆèºæ—‹ä½ç½®å’Œæœ€ç»ˆä½ç½®
                this.x = targetX * ease + Math.cos(spin + this.h*10) * spiralR;
                this.z = targetZ * ease + Math.sin(spin + this.h*10) * spiralR;
                this.y = this.y + (this.ty - this.y) * 0.05;
            } 
            else {
                // ç¨³å®šæ€ï¼šå¼ºåŠ›å¸é™„
                this.x += (this.tx - this.x) * 0.1;
                this.y += (this.ty - this.y) * 0.1;
                this.z += (this.tz - this.z) * 0.1;
            }

            // 2. 3D æ—‹è½¬ (åº”ç”¨äº¤äº’æ—‹è½¬)
            // æ—‹è½¬å…¬å¼:
            // x' = x cos Î¸ - z sin Î¸
            // z' = x sin Î¸ + z cos Î¸
            const cos = Math.cos(currentRotation);
            const sin = Math.sin(currentRotation);
            
            const rx = this.x * cos - this.z * sin;
            const rz = this.z * cos + this.x * sin;

            // 3. é€è§†æŠ•å½± (Perspective Projection)
            // æ‘„åƒæœºè®¾ç½®
            const fov = 600; 
            const camZ = -900; // æ‘„åƒæœºè·ç¦» (æ‹‰è¿‘ä»¥è·å¾—å¼º3Dæ„Ÿ)
            const viewZ = rz - camZ; // ç²’å­ç›¸å¯¹äºæ‘„åƒæœºçš„æ·±åº¦
            
            const scale = fov / (fov + viewZ); // æ ¸å¿ƒæŠ•å½±å…¬å¼
            
            this.px = width/2 + rx * scale;
            this.py = height/2 + (this.y - 100) * scale; // -100 å¾®è°ƒå‚ç›´ä½ç½®
            this.scale = scale;
            this.zDepth = viewZ; // ç”¨äºæ’åº
        }

        draw(ctx, timeline) {
            if (this.scale <= 0) return;
            
            ctx.beginPath();
            
            // ç²’å­æ„Ÿæ ¸å¿ƒï¼šæ ¹æ®æ·±åº¦ç¼©æ”¾å¤§å°
            const drawSize = this.size * this.scale;
            ctx.arc(this.px, this.py, drawSize, 0, Math.PI * 2);

            // é¢œè‰²å¤„ç†
            if (timeline < 8000) {
                // æ±‡èšæ—¶ï¼šå…¨æ¯è“
                ctx.fillStyle = `rgba(0, 255, 255, ${0.8})`;
            } else {
                if (this.type === 'light') {
                    // é—ªçƒ
                    const blink = 0.5 + 0.5 * Math.sin(timeline * 0.005 + this.blinkOffset);
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = blink;
                    // åªæœ‰ç¯å…‰æœ‰å¤§å…‰æ™•
                    ctx.shadowBlur = 15 * this.scale;
                    ctx.shadowColor = this.color;
                } else {
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = 0.9;
                    ctx.shadowBlur = 0;
                }
            }
            
            ctx.fill();
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0;
        }
    }

    // ==========================================
    //           åœ°é¢é­”æ³•é˜µ (è·Ÿéšæ—‹è½¬)
    // ==========================================
    function drawGround(timeline) {
        if (timeline < 1000) return;
        const alpha = Math.min(1, (timeline - 1000) / 3000);
        
        const fov = 600;
        const camZ = -900;
        
        // è®¡ç®—åœ°é¢çš„3Då˜æ¢
        // åœ°é¢å…¶å®å°±æ˜¯ä¸€åœˆç‚¹ï¼Œæˆ–è€…ç›´æ¥ç”»åœ†ï¼Œä½†è¦åº”ç”¨åŒæ ·çš„æ—‹è½¬çŸ©é˜µ
        
        ctx.save();
        ctx.translate(width/2, height/2); // å±å¹•ä¸­å¿ƒ
        
        // æˆ‘ä»¬ç®€å•æ¨¡æ‹Ÿï¼šç”»ä¸€ä¸ªéšæ—‹è½¬å‹ç¼©çš„æ¤­åœ†ä¸å¤ªçœŸå®
        // æˆ‘ä»¬ç”¨3Dç‚¹æ¥ç”»åœˆ
        ctx.beginPath();
        const y = 420; // åœ°é¢Yåæ ‡
        const radius = 400;
        
        for(let i=0; i<=60; i++) {
            const angle = (i / 60) * Math.PI * 2;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            
            // åº”ç”¨åŒæ ·çš„æ—‹è½¬
            const cos = Math.cos(currentRotation);
            const sin = Math.sin(currentRotation);
            const rx = x * cos - z * sin;
            const rz = z * cos + x * sin;
            
            const scale = fov / (fov + (rz - camZ));
            const px = rx * scale;
            const py = (y - 100) * scale;
            
            if (i===0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        
        ctx.closePath();
        ctx.strokeStyle = `rgba(0, 255, 255, ${0.5 * alpha})`;
        ctx.lineWidth = 3;
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#0ff';
        ctx.stroke();
        ctx.restore();
    }

    // ==========================================
    //           ç«ç®­çƒŸèŠ± (å¸¦æ‹–å°¾)
    // ==========================================
    class Firework {
        constructor() {
            this.x = Math.random() * width;
            this.y = height;
            this.targetY = height * 0.15 + Math.random() * height * 0.3;
            this.vy = -12 - Math.random() * 5;
            this.color = `hsl(${Math.random()*360}, 100%, 70%)`;
            this.state = 'rising';
            this.particles = [];
            this.trail = []; 
        }
        update() {
            if (this.state === 'rising') {
                this.y += this.vy;
                this.vy += 0.2;
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > 12) this.trail.shift();
                if (this.vy >= 0 || this.y < this.targetY) this.explode();
            } else {
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.08;
                    p.alpha -= 0.02;
                });
                this.particles = this.particles.filter(p => p.alpha > 0);
                if (this.particles.length === 0) this.state = 'dead';
            }
        }
        explode() {
            this.state = 'exploding';
            for(let i=0; i<80; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 1;
                this.particles.push({
                    x: this.x, y: this.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    alpha: 1
                });
            }
        }
        draw(ctx) {
            ctx.globalCompositeOperation = 'lighter';
            if (this.state === 'rising') {
                // æ‹–å°¾
                if (this.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);
                    for(let i=1; i<this.trail.length; i++) ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    ctx.strokeStyle = `rgba(255, 255, 200, 0.4)`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                // å¼¹å¤´
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.fill();
            } else {
                // çˆ†ç‚¸
                this.particles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                });
            }
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
        }
    }

    // æ ‘é¡¶æ˜Ÿ (è·Ÿéš3Dæ—‹è½¬)
    function drawTopStar(timeline) {
        if (timeline < 10000) return;
        const alpha = Math.min(1, (timeline - 10000) / 1000);
        
        // æ ‘é¡¶3Dåæ ‡
        const topY = 400 - 1000; // -600
        const topX = 0;
        const topZ = 0;

        // åº”ç”¨æ—‹è½¬
        const cos = Math.cos(currentRotation);
        const sin = Math.sin(currentRotation);
        const rx = topX * cos - topZ * sin;
        const rz = topZ * cos + topX * sin;

        // æŠ•å½±
        const fov = 600; const camZ = -900;
        const scale = fov / (fov + (rz - camZ));
        const px = width/2 + rx * scale;
        const py = height/2 + (topY - 100) * scale;

        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(timeline * 0.002);
        ctx.globalAlpha = alpha;
        
        ctx.globalCompositeOperation = 'lighter';
        ctx.beginPath();
        ctx.fillStyle = "#FFD700";
        ctx.shadowBlur = 40;
        ctx.shadowColor = "#FFD700";
        // ç»˜åˆ¶å…«è§’æ˜Ÿ
        for (let i = 0; i < 8; i++) {
            ctx.lineTo(Math.cos(i * Math.PI/4) * 50 * scale, Math.sin(i * Math.PI/4) * 50 * scale);
            ctx.lineTo(Math.cos((i+0.5) * Math.PI/4) * 15 * scale, Math.sin((i+0.5) * Math.PI/4) * 15 * scale);
        }
        ctx.fill();
        ctx.restore();
        
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 1;
        ctx.shadowBlur = 0;
    }

    function showSubtitle(text, duration) {
        subtitle.innerText = text;
        subtitle.style.opacity = 1;
        setTimeout(() => subtitle.style.opacity = 0, duration);
    }

    // ==========================================
    //           ä¸»å¾ªç¯
    // ==========================================
    function loop() {
        if (!isPlaying) return;
        requestAnimationFrame(loop);

        const current = Date.now();
        const timeline = current - startTime;
        
        // æƒ¯æ€§å¹³æ»‘å¤„ç†
        if (!isDragging) {
            currentRotation += autoRotateSpeed;
            targetRotation = currentRotation; // åŒæ­¥ç›®æ ‡
        } else {
            // ç®€å•çš„ lerp æ’å€¼è®©æ‹–åŠ¨æœ‰æƒ¯æ€§
            currentRotation += (targetRotation - currentRotation) * 0.1;
        }

        // æ¸…å± (é«˜é€æ˜åº¦é»‘è‰²åˆ¶é€ æ‹–å°¾)
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
        ctx.fillRect(0, 0, width, height);

        drawGround(timeline);

        // ç²’å­ç»˜åˆ¶ (å¼€å¯å åŠ æ¨¡å¼å¢å¼ºç²’å­æ„Ÿ)
        ctx.globalCompositeOperation = 'lighter'; 
        
        // æ’åºï¼šä¸ºäº†æ­£ç¡®çš„3Dé®æŒ¡å…³ç³» (Z-Sort)
        // æ€§èƒ½ä¼˜åŒ–ï¼šæ¯å¸§éƒ½æ’ï¼Œå› ä¸ºç°åœ¨æœ‰æ—‹è½¬äº¤äº’ï¼Œä¸æ’ä¼šç©¿æ¨¡
        particles.sort((a, b) => b.zDepth - a.zDepth);
        
        particles.forEach(p => { 
            p.update(timeline); 
            p.draw(ctx, timeline); 
        });
        
        ctx.globalCompositeOperation = 'source-over';

        drawTopStar(timeline);

        if (timeline > 12000) {
            if (Math.random() < 0.04) fireworks.push(new Firework());
            fireworks.forEach((f, i) => {
                f.update();
                f.draw(ctx);
                if (f.state === 'dead') fireworks.splice(i, 1);
            });
            if (timeline > 13000) document.getElementById('final-msg').style.opacity = 1;
        }

        if (timeline > 500 && timeline < 600) showSubtitle("å‡†å¤‡å¥½äº†å—...", 2000);
        if (timeline > 4000 && timeline < 4100) showSubtitle("3", 1000);
        if (timeline > 5500 && timeline < 5600) showSubtitle("2", 1000);
        if (timeline > 7000 && timeline < 7100) showSubtitle("1", 1000);
        if (timeline > 8500 && timeline < 8600) showSubtitle("åœ£è¯å¿«ä¹ï¼", 2000);
    }

    function init() {
        particles = [];
        fireworks = [];
        for (let i = 0; i < PARTICLE_COUNT; i++) particles.push(new Particle());
    }

    window.startShow = function() {
        document.getElementById('start-screen').style.opacity = 0;
        setTimeout(() => document.getElementById('start-screen').style.display = 'none', 1000);
        document.getElementById('bgm').play().catch(()=>{});
        init();
        startTime = Date.now();
        isPlaying = true;
        loop();
    }
</script>
</body>
</html>
