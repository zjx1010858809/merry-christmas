<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas</title>
    <style>
        /* --- æ ¸å¿ƒä¿®å¤ï¼šç¦æ­¢é¡µé¢æ»šåŠ¨ï¼Œç¡®ä¿æ»‘åŠ¨äº‹ä»¶åªç”¨äºæ—‹è½¬ --- */
        body, html { 
            margin: 0; padding: 0; 
            overflow: hidden; 
            background-color: #000; 
            height: 100%; 
            font-family: sans-serif; 
            touch-action: none; /* å…³é”®ï¼šç¦æ­¢æµè§ˆå™¨å¤„ç†è§¦æ‘¸æ‰‹åŠ¿ */
        }
        
        canvas { 
            display: block; 
            position: absolute; top: 0; left: 0; 
            z-index: 1; 
            cursor: grab; /* é¼ æ ‡æ‰‹åŠ¿ */
        }
        canvas:active { cursor: grabbing; }

        /* UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€UIå±‚ */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* å¯åŠ¨é¡µ */
        #start-screen {
            pointer-events: auto; /* åªæœ‰æŒ‰é’®åŒºåŸŸå¯ä»¥ç‚¹å‡» */
            background: rgba(0,0,0,0.85);
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s;
            position: absolute; top: 0; left: 0; z-index: 200;
            backdrop-filter: blur(8px);
        }

        .btn-play {
            padding: 16px 50px;
            font-size: 1.4rem;
            color: #fff;
            background: linear-gradient(135deg, #ff0055, #ffcc00);
            border: none; border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.8);
            font-weight: bold; letter-spacing: 2px;
            animation: pulse 1.2s infinite alternate;
            /* å¢å¤§ç‚¹å‡»åŒºåŸŸ */
            min-width: 200px;
            min-height: 50px;
        }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

        /* æç¤ºæ–‡å­— */
        .hint-text {
            color: #0ff; font-size: 14px; margin-top: 25px;
            animation: fadeInOut 2s infinite;
            text-shadow: 0 0 5px #0ff;
            font-weight: bold;
        }
        @keyframes fadeInOut { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }

        /* æœ€ç»ˆæ–‡å­— */
        #final-msg {
            position: absolute; bottom: 10%; width: 100%; text-align: center;
            opacity: 0; transition: opacity 2s; pointer-events: none; z-index: 300;
        }
        .msg-title {
            font-size: 3.2rem; color: #FFD700; font-weight: bold; margin-bottom: 5px;
            text-shadow: 0 0 30px #FFD700; font-family: serif;
        }
        .msg-body {
            font-size: 1.3rem; color: #fff; font-weight: bold; text-shadow: 0 2px 5px #000;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="start-screen">
        <button class="btn-play" onclick="startShow()">ğŸ ç‚¹äº®æ˜Ÿæ²³</button>
        <div class="hint-text">âœ¨ æ ‘é•¿å¥½å æ‰‹æŒ‡å·¦å³æ»‘åŠ¨æ—‹è½¬ âœ¨</div>
    </div>
    <div id="final-msg">
        <div class="msg-title">Merry Christmas</div>
        <div class="msg-body">è€å©†ï¼Œåœ£è¯å¿«ä¹ â¤ï¸</div>
    </div>
</div>

<canvas id="canvas"></canvas>
<audio id="bgm" loop>
    <source src="https://music.163.com/song/media/outer/url?id=1901371647.mp3" type="audio/mpeg">
</audio>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    let particles = [];
    let fireworks = [];
    let isPlaying = false;
    let startTime = 0;

    // --- äº¤äº’æ§åˆ¶ (ä¿®å¤ç‰ˆ) ---
    let autoRotateSpeed = 0.002; // è‡ªåŠ¨æ—‹è½¬é€Ÿåº¦
    let targetRotation = 0;
    let currentRotation = 0;
    let isDragging = false;
    let lastX = 0;
    
    // å¢åŠ ç²’å­æ•°ï¼Œç²’å­äº‘æ•ˆæœ
    const PARTICLE_COUNT = 3200; 
    
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // ==========================================
    //       å…³é”®ä¿®å¤ï¼šå…¨å±€äº¤äº’ç›‘å¬ (Touch Fix)
    // ==========================================
    
    // å¤„ç†å¼€å§‹
    function onStart(x) {
        isDragging = true;
        lastX = x;
        // å…³é”®ï¼šæŒ‰ä¸‹æ—¶ï¼Œåœæ­¢è‡ªåŠ¨æ—‹è½¬ï¼Œå¹¶åŒæ­¥ç›®æ ‡è§’åº¦ï¼Œé˜²æ­¢è·³å˜
        autoRotateSpeed = 0; 
        targetRotation = currentRotation; 
    }

    // å¤„ç†ç§»åŠ¨
    function onMove(x) {
        if (!isDragging) return;
        const delta = x - lastX;
        // è°ƒæ•´çµæ•åº¦ï¼šæ ¹æ®å±å¹•å®½åº¦è‡ªé€‚åº”
        const sensitivity = 0.005; 
        targetRotation += delta * sensitivity;
        lastX = x;
    }

    // å¤„ç†ç»“æŸ
    function onEnd() {
        isDragging = false;
        // æ¢å¤ç¼“æ…¢è‡ªåŠ¨æ—‹è½¬ (æ–¹å‘æ ¹æ®æœ€åçš„æ‰‹åŠ¿)
        autoRotateSpeed = 0.001;
    }

    // --- ç»‘å®šåˆ° document ä»¥ç¡®ä¿ä¸è¢«é®æŒ¡ ---
    // è§¦æ‘¸äº‹ä»¶ (æ‰‹æœº) - æ·»åŠ  passive: false ä»¥å…è®¸ preventDefault
    document.addEventListener('touchstart', e => {
        onStart(e.touches[0].clientX);
    }, { passive: false });

    document.addEventListener('touchmove', e => {
        if (isDragging) e.preventDefault(); // æ ¸å¿ƒï¼šç¦æ­¢é¡µé¢æ»šåŠ¨
        onMove(e.touches[0].clientX);
    }, { passive: false });

    document.addEventListener('touchend', onEnd);

    // é¼ æ ‡äº‹ä»¶ (ç”µè„‘)
    document.addEventListener('mousedown', e => onStart(e.clientX));
    document.addEventListener('mousemove', e => onMove(e.clientX));
    document.addEventListener('mouseup', onEnd);


    // ==========================================
    //           3D ç²’å­ç³»ç»Ÿ
    // ==========================================
    class Particle {
        constructor() {
            this.reset(true);
        }

        reset(isInit = false) {
            this.h = Math.random(); 
            
            // æ ‘é«˜ 1100ï¼Œåº•éƒ¨Y=450
            const treeH = 1100;
            const bottomY = 450;
            this.ty = bottomY - this.h * treeH;

            // 3D åæ ‡ç”Ÿæˆ (åœ†é”¥)
            const maxR = 380 * Math.pow(1 - this.h, 0.6);
            const r = maxR * Math.sqrt(Math.random()); 
            const angle = Math.random() * Math.PI * 2;
            
            this.tx = Math.cos(angle) * r;
            this.tz = Math.sin(angle) * r;

            // ç±»å‹
            const rand = Math.random();
            if (rand < 0.15) { // æ ‘å¹²
                this.type = 'trunk';
                const trunkH = Math.random();
                this.ty = bottomY - trunkH * (treeH * 0.3);
                const trunkR = 30 * Math.sqrt(Math.random());
                this.tx = Math.cos(angle) * trunkR;
                this.tz = Math.sin(angle) * trunkR;
                this.color = `hsla(${30+Math.random()*10}, 60%, 30%, 1)`;
                this.size = 2.2;
            } else if (rand < 0.25) { // éœ“è™¹ç¯
                this.type = 'light';
                this.color = Math.random() > 0.5 ? '#FFD700' : `hsl(${Math.random()*360}, 100%, 70%)`;
                this.size = 4.0; // ç¯å¤§ä¸€ç‚¹
                this.blinkOffset = Math.random() * 100;
            } else { // å¶å­
                this.type = 'leaf';
                const hue = 120 + Math.random() * 40;
                const light = 20 + this.h * 40;
                this.color = `hsla(${hue}, 80%, ${light}%, 1)`;
                this.size = 2.0;
            }

            // åˆå§‹å¤§çˆ†ç‚¸
            if (isInit) {
                const startR = 1500;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI;
                this.x = startR * Math.sin(phi) * Math.cos(theta);
                this.y = startR * Math.sin(phi) * Math.sin(theta);
                this.z = startR * Math.cos(phi);
            } else {
                this.x = this.tx; this.y = this.ty; this.z = this.tz;
            }
        }

        update(timeline) {
            // 1. åŠ¨ç”»é€»è¾‘
            if (timeline < 8000) {
                const p = timeline / 8000;
                const ease = p * p * (3 - 2 * p);
                
                // èºæ—‹å¸é™„
                const currentY = this.y + (this.ty - this.y) * 0.1;
                const spiralR = 1000 * (1 - ease);
                const spin = (1-ease) * 10;
                
                this.x = this.tx * ease + Math.cos(spin + this.h*10) * spiralR;
                this.z = this.tz * ease + Math.sin(spin + this.h*10) * spiralR;
                this.y = this.y + (this.ty - this.y) * 0.05;
            } else {
                this.x += (this.tx - this.x) * 0.1;
                this.y += (this.ty - this.y) * 0.1;
                this.z += (this.tz - this.z) * 0.1;
            }

            // 2. æ—‹è½¬é€»è¾‘ (åº”ç”¨æ‰‹æŒ‡æ»‘åŠ¨)
            const cos = Math.cos(currentRotation);
            const sin = Math.sin(currentRotation);
            const rx = this.x * cos - this.z * sin;
            const rz = this.z * cos + this.x * sin;

            // 3. 3D æŠ•å½±
            const fov = 600; 
            const camZ = -900; 
            const scale = fov / (fov + (rz - camZ));
            
            this.px = width/2 + rx * scale;
            this.py = height/2 + (this.y - 100) * scale;
            this.scale = scale;
            this.zDepth = rz; // æ·±åº¦æ’åºç”¨
        }

        draw(ctx, timeline) {
            if (this.scale <= 0) return;
            
            ctx.beginPath();
            const drawSize = this.size * this.scale;
            ctx.arc(this.px, this.py, drawSize, 0, Math.PI * 2);

            if (timeline < 8000) {
                ctx.fillStyle = `rgba(0, 255, 255, ${0.8})`; // æ±‡èšæ—¶è“è‰²
            } else {
                if (this.type === 'light') {
                    const blink = 0.5 + 0.5 * Math.sin(timeline * 0.005 + this.blinkOffset);
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = blink;
                    ctx.shadowBlur = 15 * this.scale;
                    ctx.shadowColor = this.color;
                } else {
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = 1;
                    ctx.shadowBlur = 0;
                }
            }
            ctx.fill();
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0;
        }
    }

    // åœ°é¢
    function drawGround(timeline) {
        if (timeline < 1000) return;
        const alpha = Math.min(1, (timeline - 1000) / 2000);
        
        ctx.save();
        ctx.translate(width/2, height/2);
        
        // ç»˜åˆ¶3Dåœ†ç¯
        const radius = 450;
        const y = 460;
        
        ctx.beginPath();
        for(let i=0; i<=60; i++) {
            const angle = (i/60) * Math.PI*2;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            
            // æ—‹è½¬
            const cos = Math.cos(currentRotation);
            const sin = Math.sin(currentRotation);
            const rx = x * cos - z * sin;
            const rz = z * cos + x * sin;
            
            const fov = 600; const camZ = -900;
            const scale = fov / (fov + (rz - camZ));
            
            const px = rx * scale;
            const py = (y - 100) * scale;
            
            if (i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
        }
        ctx.strokeStyle = `rgba(0, 255, 255, ${0.4 * alpha})`;
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
    }

    // ç«ç®­çƒŸèŠ±
    class Firework {
        constructor() {
            this.x = Math.random() * width;
            this.y = height;
            this.targetY = height * 0.15 + Math.random() * height * 0.3;
            this.vy = -12 - Math.random() * 5;
            this.color = `hsl(${Math.random()*360}, 100%, 70%)`;
            this.state = 'rising';
            this.particles = [];
            this.trail = [];
        }
        update() {
            if (this.state === 'rising') {
                this.y += this.vy;
                this.vy += 0.2;
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > 10) this.trail.shift();
                if (this.vy >= 0 || this.y < this.targetY) this.explode();
            } else {
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.08;
                    p.alpha -= 0.02;
                });
                this.particles = this.particles.filter(p => p.alpha > 0);
                if (this.particles.length === 0) this.state = 'dead';
            }
        }
        explode() {
            this.state = 'exploding';
            for(let i=0; i<80; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 1;
                this.particles.push({
                    x: this.x, y: this.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    alpha: 1
                });
            }
        }
        draw(ctx) {
            ctx.globalCompositeOperation = 'lighter';
            if (this.state === 'rising') {
                if (this.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);
                    for(let i=1; i<this.trail.length; i++) ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    ctx.strokeStyle = `rgba(255, 255, 200, 0.4)`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
                ctx.fillStyle = '#fff'; ctx.fill();
            } else {
                this.particles.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
                    ctx.fillStyle = this.color; ctx.globalAlpha = p.alpha; ctx.fill();
                });
            }
            ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1;
        }
    }

    // æ ‘é¡¶æ˜Ÿ
    function drawTopStar(timeline) {
        if (timeline < 10000) return;
        const alpha = Math.min(1, (timeline - 10000) / 1000);
        
        // æ ‘é¡¶ Y = -650 (bottom 450 - tree 1100)
        const topY = -650; const topX = 0; const topZ = 0;
        
        const cos = Math.cos(currentRotation);
        const sin = Math.sin(currentRotation);
        const rx = topX * cos - topZ * sin;
        const rz = topZ * cos + topX * sin;
        
        const fov = 600; const camZ = -900;
        const scale = fov / (fov + (rz - camZ));
        const px = width/2 + rx * scale;
        const py = height/2 + (topY - 100) * scale;
        
        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(timeline * 0.002);
        ctx.globalAlpha = alpha;
        ctx.globalCompositeOperation = 'lighter';
        ctx.beginPath();
        ctx.fillStyle = "#FFD700";
        ctx.shadowBlur = 40; ctx.shadowColor = "#FFD700";
        for (let i = 0; i < 8; i++) {
            ctx.lineTo(Math.cos(i*Math.PI/4)*50*scale, Math.sin(i*Math.PI/4)*50*scale);
            ctx.lineTo(Math.cos((i+0.5)*Math.PI/4)*15*scale, Math.sin((i+0.5)*Math.PI/4)*15*scale);
        }
        ctx.fill();
        ctx.restore();
        ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1; ctx.shadowBlur = 0;
    }

    function loop() {
        if (!isPlaying) return;
        requestAnimationFrame(loop);
        const timeline = Date.now() - startTime;

        // æƒ¯æ€§å¹³æ»‘
        if (!isDragging) {
            currentRotation += autoRotateSpeed;
            targetRotation = currentRotation;
        } else {
            currentRotation += (targetRotation - currentRotation) * 0.1;
        }

        ctx.fillStyle = 'rgba(0, 0, 0, 0.25)'; 
        ctx.fillRect(0, 0, width, height);

        drawGround(timeline);

        ctx.globalCompositeOperation = 'lighter'; 
        // å¿…é¡»æ’åºï¼Œå¦åˆ™3Dç©¿æ¨¡
        particles.sort((a, b) => b.zDepth - a.zDepth);
        particles.forEach(p => { p.update(timeline); p.draw(ctx, timeline); });
        ctx.globalCompositeOperation = 'source-over'; 

        drawTopStar(timeline);

        if (timeline > 12000) {
            if (Math.random() < 0.04) fireworks.push(new Firework());
            fireworks.forEach((f, i) => { f.update(); f.draw(ctx); if (f.state === 'dead') fireworks.splice(i, 1); });
            if (timeline > 13000) document.getElementById('final-msg').style.opacity = 1;
        }
    }

    function init() {
        particles = [];
        fireworks = [];
        for (let i = 0; i < PARTICLE_COUNT; i++) particles.push(new Particle());
    }

    window.startShow = function() {
        document.getElementById('start-screen').style.opacity = 0;
        setTimeout(() => document.getElementById('start-screen').style.display = 'none', 1000);
        document.getElementById('bgm').play().catch(()=>{});
        init();
        startTime = Date.now();
        isPlaying = true;
        loop();
    }
</script>
</body>
</html>
