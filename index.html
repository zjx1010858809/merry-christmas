<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Christmas For You</title>
    <style>
        /* åŸºç¡€è®¾ç½® */
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; height: 100%; font-family: "Microsoft YaHei", sans-serif; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        /* UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* 1. å¼€åœº */
        #start-screen {
            pointer-events: auto;
            background: #000;
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1.5s ease-in-out;
            position: absolute; top: 0; left: 0; z-index: 200;
        }

        .btn-play {
            padding: 16px 48px;
            font-size: 1.2rem;
            color: #fff;
            background: linear-gradient(90deg, #ff0033, #cc00cc);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(255, 0, 51, 0.5);
            font-weight: bold;
            letter-spacing: 3px;
            animation: breathe 2s infinite;
        }
        @keyframes breathe { 0% { transform: scale(1); box-shadow: 0 0 25px rgba(255,0,51,0.5); } 50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(204,0,204,0.8); } 100% { transform: scale(1); box-shadow: 0 0 25px rgba(255,0,51,0.5); } }

        /* 2. å­—å¹• */
        #subtitle {
            position: absolute; bottom: 12%; width: 100%; text-align: center;
            color: #fff; font-size: 1.2rem; letter-spacing: 3px;
            text-shadow: 0 0 8px rgba(255,255,255,0.8);
            opacity: 0; transition: opacity 1.5s; font-weight: 300;
        }

        /* 3. æœ€ç»ˆç¥ç¦ */
        #final-msg {
            position: absolute; top: 15%; width: 100%; text-align: center;
            opacity: 0; transition: opacity 3s; pointer-events: none;
            z-index: 300;
        }
        .msg-title {
            font-size: 3rem; color: #FFD700; font-weight: bold; margin-bottom: 15px;
            text-shadow: 0 0 30px #FFD700;
            font-family: 'Times New Roman', serif;
        }
        .msg-body {
            font-size: 1.1rem; color: #eee; line-height: 1.8; letter-spacing: 1px;
            text-shadow: 0 2px 5px #000; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="start-screen">
        <button class="btn-play" onclick="startCinematic()">ğŸ„ ç‚¹äº®åœ£è¯æ ‘</button>
        <p style="color:#555; font-size:12px; margin-top:15px;">å…¨å±è§‚çœ‹ä½“éªŒæ›´ä½³</p>
    </div>
    <div id="subtitle"></div>
    <div id="final-msg">
        <div class="msg-title">Merry Christmas</div>
        <div class="msg-body">
            è€å©†ï¼Œæ„¿ä½ çš„ç”Ÿæ´»<br>
            å¦‚è¿™æ£µæ ‘èˆ¬ æç¹å¶èŒ‚ï¼Œå…‰èŠ’ä¸‡ä¸ˆ â¤ï¸
        </div>
    </div>
</div>

<canvas id="canvas"></canvas>

<audio id="bgm" loop>
    <source src="https://music.163.com/song/media/outer/url?id=1860000632.mp3" type="audio/mpeg">
</audio>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const subtitle = document.getElementById('subtitle');
    
    let width, height;
    let particles = [];
    let fireworks = [];
    let stars = []; 
    
    let startTime = 0;
    let isPlaying = false;
    
    // å¢åŠ ç²’å­æ•°ï¼Œä¿è¯æ ‘å¹²å’Œåº•éƒ¨å¡«å……
    const PARTICLE_COUNT = 3800; 
    
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // ==========================================
    //           æ ¸å¿ƒç²’å­ç³»ç»Ÿ (ä¿®æ­£ç‰ˆ)
    // ==========================================
    class Particle {
        constructor() {
            // éšæœºæ•°å†³å®šç±»å‹ï¼š15%æ ‘å¹²ï¼Œ85%æ ‘å† 
            const randType = Math.random();
            
            // --- æ ‘å¹²é€»è¾‘ (TRUNK) ---
            if (randType < 0.15) {
                this.role = 'trunk';
                // æ ‘å¹²æ˜¯åœ†æŸ±ä½“ï¼Œç¨å¾®æœ‰ç‚¹åœ†é”¥æ„Ÿï¼ˆåº•éƒ¨ç•¥å®½ï¼‰
                const h = Math.random(); // 0-1
                // æ ‘å¹²é«˜åº¦ï¼šä»åº•éƒ¨(300) åˆ° ä¸­éƒ¨(-100)
                this.ty = 300 - h * 400; 
                
                // æ ‘å¹²åŠå¾„ï¼šåº•éƒ¨å®½(40)ï¼Œé¡¶éƒ¨çª„(15)
                const maxR = 40 - h * 25; 
                const r = maxR * Math.sqrt(Math.random()); // å†…éƒ¨å¡«å……
                const angle = Math.random() * Math.PI * 2;
                
                this.tx = Math.cos(angle) * r;
                this.tz = Math.sin(angle) * r;
                
                // é¢œè‰²ï¼šæ·±æ£•è‰²/æœ¨è‰²
                const lightness = 15 + Math.random() * 20;
                this.color = `hsl(${25 + Math.random()*10}, 60%, ${lightness}%)`;
                this.size = 2 + Math.random() * 2;
                this.type = 'wood';
            } 
            // --- æ ‘å† é€»è¾‘ (TREE BODY) ---
            else {
                this.role = 'tree';
                this.h = Math.random(); 
                
                // --- ä¿®æ­£1ï¼šé«˜åº¦è°ƒæ•´ ---
                // æ—§ç‰ˆèŒƒå›´ 950ï¼Œå¯¼è‡´é¡¶éƒ¨æº¢å‡º
                // æ–°ç‰ˆï¼šåº•éƒ¨ 280ï¼Œé¡¶éƒ¨ -480 (æ€»é«˜760)ï¼Œç¡®ä¿åœ¨å±å¹•å†…
                this.ty = 280 - this.h * 760;

                // --- ä¿®æ­£2ï¼šåº•éƒ¨åŠ å®½å¡«å…… ---
                // ä½¿ç”¨ pow(x, 0.8) è®©åº•éƒ¨æ›²çº¿æ›´é¥±æ»¡
                const widthFactor = Math.pow(1 - this.h, 0.8);
                const maxR = Math.min(width, height) * 0.42 * widthFactor; 
                
                // å†…éƒ¨å¡«å……ç®—æ³•
                const r = maxR * Math.sqrt(Math.random()); 
                const angle = Math.random() * Math.PI * 2 * 12; 
                
                this.tx = Math.cos(angle) * r;
                this.tz = Math.sin(angle) * r;

                // é¢œè‰²ä¸ç±»å‹
                const subRand = Math.random();
                if (subRand < 0.05) { 
                    this.type = 'star'; this.color = '#fff'; this.size = 2.5; 
                } else if (subRand < 0.20) { 
                    this.type = 'light'; 
                    this.color = Math.random() > 0.6 ? '#FFD700' : `hsl(${Math.random()*360}, 100%, 65%)`;
                    this.size = 3; 
                } else { 
                    this.type = 'leaf'; 
                    // åº•éƒ¨å¶å­æ·±è‰²ï¼Œé¡¶éƒ¨å«©ç»¿
                    const l = 15 + this.h * 20 + Math.random()*20;
                    this.color = `hsl(${110 + Math.random()*40}, 70%, ${l}%)`; 
                    this.size = 1.6; 
                }
            }

            // åˆå§‹çŠ¶æ€ï¼šæ•£å¸ƒåœ¨åº•éƒ¨çš„å·¨å¤§å…‰ç›˜
            const floorAngle = Math.random() * Math.PI * 2;
            const floorR = 100 + Math.random() * 700;
            this.x = Math.cos(floorAngle) * floorR;
            this.y = 800; // å±å¹•ä¸‹æ–¹
            this.z = Math.sin(floorAngle) * floorR;

            this.wobble = Math.random() * 100;
        }

        update(timeline) {
            // --- A: æ—‹è½¬ç­‰å¾… (0-5s) ---
            if (timeline < 5000) {
                const rotSpeed = 0.003;
                const dist = Math.sqrt(this.x*this.x + this.z*this.z);
                const angle = Math.atan2(this.z, this.x) + rotSpeed;
                this.x = Math.cos(angle) * dist;
                this.z = Math.sin(angle) * dist;
                this.y = 800 + Math.sin(timeline * 0.002 + this.wobble) * 10;
            }
            
            // --- B: èºæ—‹æ±‡èš (5-14s) ---
            else if (timeline < 14000) {
                const progress = (timeline - 5000) / 9000;
                
                // æ ‘å¹²å…ˆé£ï¼Œæ ‘å† åé£
                let delay = this.role === 'trunk' ? 0 : (1 - this.h) * 0.3;
                
                let p = Math.max(0, (progress - delay) / (1 - delay));
                p = p < 0.5 ? 2*p*p : -1+(4-2*p)*p; // EaseInOut

                if (p > 0) {
                    // é«˜åº¦æ’å€¼
                    this.y = 800 + (this.ty - 800) * p;
                    
                    // èºæ—‹åŠå¾„æ’å€¼
                    const currentDist = Math.sqrt(this.x*this.x + this.z*this.z);
                    const targetDist = Math.sqrt(this.tx*this.tx + this.tz*this.tz);
                    
                    // æ ‘å¹²ç›´æ¥å¯¹é½ï¼Œæ ‘å† èºæ—‹
                    if (this.role === 'trunk') {
                        this.x += (this.tx - this.x) * 0.1;
                        this.z += (this.tz - this.z) * 0.1;
                    } else {
                        // èºæ—‹é€»è¾‘
                        const r = currentDist + (targetDist - currentDist) * p * 0.15;
                        const originalAngle = Math.atan2(this.z, this.x);
                        const spin = p * (8 + this.h * 5); 
                        const angle = originalAngle + spin;
                        
                        if (p < 0.9) {
                            const spiralR = 600 * (1-p) + targetDist * p;
                            this.x = Math.cos(angle) * spiralR;
                            this.z = Math.sin(angle) * spiralR;
                        } else {
                            this.x += (this.tx - this.x) * 0.1;
                            this.z += (this.tz - this.z) * 0.1;
                        }
                    }
                }
            }
            
            // --- C: ç¨³å®šæœŸ (14s+) ---
            else {
                // å¼ºåŠ›å¸é™„
                this.x += (this.tx - this.x) * 0.1;
                this.y += (this.ty - this.y) * 0.1;
                this.z += (this.tz - this.z) * 0.1;
                
                // --- ä¿®æ­£3ï¼šå‡å¼±æ‘‡æ™ƒ ---
                if (timeline > 16000) {
                    // é£åŠ›ç³»æ•°ä» 5 é™åˆ° 1.5ï¼Œåªæœ‰æ ‘å† æ‘‡ï¼Œæ ‘å¹²ä¸æ‘‡
                    if (this.role === 'tree') {
                        const wind = Math.sin(timeline * 0.002 + this.y * 0.005) * (this.h * 1.5);
                        this.x += wind; 
                        this.z += wind * 0.5;
                    }
                }
            }

            // --- 3D æŠ•å½±ä¸è¿é•œ ---
            let camY, camZ;
            
            if (timeline < 5000) {
                camY = -1200; camZ = -200;
            } else if (timeline < 14000) {
                const p = (timeline - 5000) / 9000;
                camY = -1200 + p * 1200; 
                camZ = -200 + p * (-700); 
            } else {
                // --- ä¿®æ­£4ï¼šè§†è§’è°ƒæ•´ ---
                // CamY = 0 (å‚ç›´å±…ä¸­)
                // CamZ = -900 (æ‹‰å¾—æ›´è¿œä¸€ç‚¹ï¼Œä¿è¯èƒ½çœ‹åˆ°æ ‘å°–)
                camY = 0; 
                camZ = -900; 
            }

            // æ•´ä½“ç¼“æ…¢æ—‹è½¬
            let finalX = this.x;
            let finalZ = this.z;
            if (timeline > 14000) {
                const rot = (timeline - 14000) * 0.0003;
                const cos = Math.cos(rot);
                const sin = Math.sin(rot);
                finalX = this.x * cos - this.z * sin;
                finalZ = this.z * cos + this.x * sin;
            }

            // æŠ•å½±
            const perspective = 600;
            const scale = perspective / (perspective + finalZ - camZ);
            
            this.px = width/2 + finalX * scale;
            this.py = height/2 + (this.y - camY) * scale;
            this.scale = scale;
        }

        draw(ctx, timeline) {
            if (this.scale <= 0) return;
            
            ctx.beginPath();
            ctx.arc(this.px, this.py, this.size * this.scale, 0, Math.PI * 2);
            
            // æ˜Ÿæ²³æ±‡èšç‰¹æ•ˆ (å…¨è“)
            if (timeline > 5000 && timeline < 14000) {
                if (this.role === 'trunk') {
                    ctx.fillStyle = '#8B4513'; // æ ‘å¹²ä¿æŒåŸè‰²
                } else {
                    ctx.fillStyle = '#00FFFF';
                    ctx.shadowBlur = 8 * this.scale;
                    ctx.shadowColor = '#0000FF';
                }
                ctx.globalAlpha = 0.8;
            } 
            else {
                // ç‚¹ç¯
                if (this.type === 'light' && timeline > 16000) {
                    const lightTime = 16000 + (1 - this.h) * 2000;
                    if (timeline > lightTime) {
                        ctx.fillStyle = this.color;
                        ctx.shadowBlur = 15 * this.scale;
                        ctx.shadowColor = this.color;
                        const blink = 0.5 + 0.5 * Math.sin(timeline * 0.005 + this.wobble);
                        ctx.globalAlpha = 0.8 * blink;
                    } else {
                        ctx.fillStyle = '#222';
                        ctx.globalAlpha = 0.3;
                        ctx.shadowBlur = 0;
                    }
                } else {
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = 1;
                    ctx.shadowBlur = 0;
                }
            }
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    // çƒŸèŠ±
    class Firework {
        constructor() {
            this.x = Math.random() * width;
            this.y = height;
            this.targetY = height * 0.15 + Math.random() * height * 0.35;
            this.vy = -10 - Math.random() * 6;
            this.color = `hsl(${Math.random()*360}, 100%, 65%)`;
            this.state = 'rising'; 
            this.particles = [];
        }
        update() {
            if (this.state === 'rising') {
                this.y += this.vy;
                this.vy += 0.2;
                if (this.vy >= 0 || this.y < this.targetY) this.explode();
            } else if (this.state === 'exploding') {
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.08;
                    p.alpha -= 0.015;
                });
                this.particles = this.particles.filter(p => p.alpha > 0);
                if (this.particles.length === 0) this.state = 'dead';
            }
        }
        explode() {
            this.state = 'exploding';
            for (let i = 0; i < 60; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 4 + 1;
                this.particles.push({
                    x: this.x, y: this.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    alpha: 1
                });
            }
        }
        draw(ctx) {
            ctx.globalCompositeOperation = 'lighter';
            if (this.state === 'rising') {
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.fill();
            } else {
                this.particles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                });
            }
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
        }
    }

    // èƒŒæ™¯æ˜Ÿ
    class Star {
        constructor() { this.reset(); }
        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 2;
            this.speed = Math.random() * 0.5 + 0.2;
            this.isShooting = Math.random() < 0.02; 
            if (this.isShooting) {
                this.x = Math.random() * width + 200;
                this.y = -100;
                this.speed = 10 + Math.random() * 10;
            }
        }
        update() {
            if (this.isShooting) {
                this.x -= this.speed;
                this.y += this.speed;
                if (this.x < -100 || this.y > height + 100) this.reset();
            } else {
                this.y -= this.speed;
                if (this.y < 0) this.y = height;
            }
        }
        draw(ctx) {
            ctx.fillStyle = this.isShooting ? '#fff' : 'rgba(255,255,255,0.4)';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
            ctx.fill();
        }
    }

    // æ ‘é¡¶å¤§æ˜Ÿ
    function drawTopStar(timeline) {
        if (timeline < 17000) return;
        const alpha = Math.min(1, (timeline - 17000) / 2000);
        
        // æ ‘é¡¶åæ ‡ ty = -480
        const camY = 0; 
        const camZ = -900;
        const perspective = 600;
        const scale = perspective / (perspective + 0 - camZ); 
        const px = width/2;
        const py = height/2 + (-480 - camY) * scale;

        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(timeline * 0.001);
        ctx.globalAlpha = alpha;
        
        ctx.beginPath();
        ctx.fillStyle = "#FFD700";
        ctx.shadowBlur = 50;
        ctx.shadowColor = "#FFD700";
        for (let i = 0; i < 5; i++) {
            ctx.lineTo(Math.cos((18 + i * 72) * 0.01745) * 40 * scale,
                       -Math.sin((18 + i * 72) * 0.01745) * 40 * scale);
            ctx.lineTo(Math.cos((54 + i * 72) * 0.01745) * 15 * scale,
                       -Math.sin((54 + i * 72) * 0.01745) * 15 * scale);
        }
        ctx.fill();
        ctx.restore();
        ctx.globalAlpha = 1;
        ctx.shadowBlur = 0;
    }

    function showSubtitle(text, duration) {
        subtitle.innerText = text;
        subtitle.style.opacity = 1;
        setTimeout(() => subtitle.style.opacity = 0, duration);
    }

    function loop() {
        if (!isPlaying) return;
        requestAnimationFrame(loop);

        const current = Date.now();
        const timeline = current - startTime;

        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.fillRect(0, 0, width, height);

        stars.forEach(s => { s.update(); s.draw(ctx); });

        if (timeline < 20000 && timeline % 3 === 0) {
            particles.sort((a, b) => b.scale - a.scale); 
        }
        particles.forEach(p => { p.update(timeline); p.draw(ctx, timeline); });

        drawTopStar(timeline);

        if (timeline > 19000) {
            if (Math.random() < 0.04) fireworks.push(new Firework());
            fireworks.forEach((f, i) => {
                f.update();
                f.draw(ctx);
                if (f.state === 'dead') fireworks.splice(i, 1);
            });
            if (timeline > 20000) document.getElementById('final-msg').style.opacity = 1;
        }

        if (timeline > 1000 && timeline < 1100) showSubtitle("æ˜Ÿæ²³æ²‰ç¡...", 3000);
        if (timeline > 5500 && timeline < 5600) showSubtitle("æ˜Ÿå…‰ä¸ºä½ æ±‡èš...", 3000);
        if (timeline > 14000 && timeline < 14100) showSubtitle("å‡ç»“æˆæ°¸æ’...", 3000);
        if (timeline > 17000 && timeline < 17100) showSubtitle("åœ£è¯å¿«ä¹...", 3000);
    }

    function init() {
        particles = [];
        stars = [];
        for (let i = 0; i < PARTICLE_COUNT; i++) particles.push(new Particle());
        for (let i = 0; i < 150; i++) stars.push(new Star());
    }

    window.startCinematic = function() {
        document.getElementById('start-screen').style.opacity = 0;
        setTimeout(() => document.getElementById('start-screen').style.display = 'none', 1500);
        document.getElementById('bgm').play().catch(()=>{});
        
        init();
        startTime = Date.now();
        isPlaying = true;
        loop();
    }
</script>
</body>
</html>
