<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; height: 100%; font-family: sans-serif; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* å¯åŠ¨æŒ‰é’® */
        #start-screen {
            pointer-events: auto;
            background: rgba(0,0,0,0.9);
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
            position: absolute; top: 0; left: 0; z-index: 20;
        }

        .btn-play {
            padding: 15px 50px; font-size: 1.2rem; color: #fff;
            background: #e60073; /* çº¯è‰²èƒŒæ™¯æ¯”æ¸å˜æ€§èƒ½å¥½ä¸€ç‚¹ç‚¹ï¼Œä½†ä¹Ÿå¥½çœ‹ */
            border: 2px solid #fff; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(230, 0, 115, 0.8);
            font-weight: bold; letter-spacing: 2px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 50% { transform: scale(1.05); } }

        .hint { color: #888; margin-top: 20px; font-size: 14px; }

        /* å­—å¹• */
        #subtitle {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            color: #fff; font-size: 1.2rem;
            text-shadow: 0 0 5px #000; opacity: 0; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="start-screen">
        <button id="playBtn" class="btn-play">ğŸ ç‚¹äº®æ˜Ÿæ²³</button>
        <div class="hint">æµç•…æ¨¡å¼ | æ‰‹æŒ‡æ»‘åŠ¨æ—‹è½¬</div>
    </div>
    <div id="subtitle"></div>
</div>

<canvas id="canvas"></canvas>
<audio id="bgm" loop>
    <source src="https://music.163.com/song/media/outer/url?id=1901371647.mp3" type="audio/mpeg">
</audio>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const subtitle = document.getElementById('subtitle');
    const startScreen = document.getElementById('start-screen');
    const playBtn = document.getElementById('playBtn');
    
    let width, height;
    let renderList = [];
    let fireworks = [];
    let isPlaying = false;
    let startTime = 0;
    
    // --- æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒï¼šå¤§å¹…å‡å°‘ç²’å­æ•°ï¼Œä½†å¢å¤§å°ºå¯¸ ---
    const PARTICLE_COUNT = 1500; 
    
    // æ‘„åƒæœº
    let cameraZ = -800;
    let angleY = 0;
    
    // äº¤äº’
    let isDragging = false;
    let lastX = 0;
    let velocity = 0;

    // 3D æ–‡å­—
    const WISH_WORDS = [
        { text: "è€å©†", y: -650, color: "#FF3366", size: 50 },
        { text: "åœ£è¯å¿«ä¹", y: -450, color: "#FFD700", size: 40 },
        { text: "å¹³å®‰å–œä¹", y: -250, color: "#00FFFF", size: 35 },
        { text: "æ°¸è¿œçˆ±ä½ ", y: 0, color: "#FF69B4", size: 40 }
    ];

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- äº¤äº’äº‹ä»¶ (é˜²è¯¯è§¦ä¼˜åŒ–) ---
    function onStart(x) { isDragging = true; lastX = x; velocity = 0; }
    function onMove(x) {
        if (!isDragging) return;
        const delta = x - lastX;
        lastX = x;
        angleY += delta * 0.008; // æé«˜ä¸€ç‚¹çµæ•åº¦
        velocity = delta * 0.008;
    }
    function onEnd() { isDragging = false; }

    document.addEventListener('touchstart', e => { if(e.target !== playBtn) e.preventDefault(); onStart(e.touches[0].clientX); }, {passive: false});
    document.addEventListener('touchmove', e => { if(e.target !== playBtn) e.preventDefault(); onMove(e.touches[0].clientX); }, {passive: false});
    document.addEventListener('touchend', onEnd);
    document.addEventListener('mousedown', e => onStart(e.clientX));
    document.addEventListener('mousemove', e => onMove(e.clientX));
    document.addEventListener('mouseup', onEnd);
    
    playBtn.addEventListener('click', startShow);
    playBtn.addEventListener('touchend', startShow);

    // ==========================================
    //           è½»é‡çº§ 3D å¯¹è±¡
    // ==========================================
    class Point3D {
        constructor(type) {
            this.type = type; 
            this.reset();
        }
        
        reset() {
            this.h = Math.random();
            const treeH = 1100;
            const bottomY = 500;
            
            if (this.type === 'tree') {
                this.ty = bottomY - this.h * treeH;
                const maxR = 380 * Math.pow(1 - this.h, 0.6);
                const r = maxR * Math.sqrt(Math.random());
                const angle = Math.random() * Math.PI * 2;
                
                this.tx = Math.cos(angle) * r;
                this.tz = Math.sin(angle) * r;
                
                const rand = Math.random();
                if (rand < 0.15) { // å½©ç¯
                    this.style = 'light'; 
                    this.color = Math.random()>0.5 ? '#FFD700' : `hsl(${Math.random()*360},100%,60%)`; 
                    this.size = 6; // ç¯å¤§ä¸€ç‚¹
                } else { // æ ‘å¶
                    this.style = 'leaf'; 
                    // é¢„è®¡ç®—é¢œè‰²ï¼Œé¿å…å®æ—¶è®¡ç®—
                    const l = 20 + this.h * 30;
                    this.color = `hsl(120, 70%, ${l}%)`; 
                    this.size = 3.5; // å¶å­ä¹Ÿå¤§ä¸€ç‚¹ï¼Œå¡«è¡¥ç©ºéš™
                }
            } else if (this.type === 'ribbon') {
                this.ty = bottomY - this.h * treeH;
                const maxR = 400 * (1 - this.h) + 20;
                const angle = this.h * 20;
                this.tx = Math.cos(angle) * maxR;
                this.tz = Math.sin(angle) * maxR;
                this.style = 'gold'; this.color = '#FFD700'; this.size = 3;
            }

            this.x = 0; this.y = 0; this.z = 0;
        }

        update(timeline) {
            if (timeline < 6000) {
                const p = timeline / 6000;
                const ease = p * p * (3 - 2 * p);
                
                const spiralR = 1000 * (1 - ease) + 50;
                const spin = (1 - ease) * 10;
                const angle = spin + this.h * 10;
                
                this.x = Math.cos(angle) * spiralR;
                this.z = Math.sin(angle) * spiralR;
                this.y = 1000 + (this.ty - 1000) * ease;
            } else {
                this.x += (this.tx - this.x) * 0.15;
                this.y += (this.ty - this.y) * 0.15;
                this.z += (this.tz - this.z) * 0.15;
            }
        }
    }

    class Text3D {
        constructor(config, angleOffset) {
            this.text = config.text;
            this.baseY = config.y;
            this.color = config.color;
            this.fontSize = config.size;
            this.angleOffset = angleOffset;
            this.radius = 500;
            this.type = 'text';
        }
        update(timeline) {
            this.y = this.baseY + Math.sin(timeline * 0.002 + this.angleOffset) * 15;
            this.x = Math.cos(this.angleOffset) * this.radius;
            this.z = Math.sin(this.angleOffset) * this.radius;
        }
    }

    function init() {
        renderList = [];
        // ç²’å­æ•°å‡åŠï¼Œæ€§èƒ½ç¿»å€
        for (let i = 0; i < 1500; i++) renderList.push(new Point3D('tree'));
        for (let i = 0; i < 200; i++) renderList.push(new Point3D('ribbon'));
        
        for (let i = 0; i < WISH_WORDS.length; i++) {
            const angle = (i / WISH_WORDS.length) * Math.PI * 2 + Math.PI; 
            renderList.push(new Text3D(WISH_WORDS[i], angle));
        }
    }

    function showSubtitle(text, duration) {
        subtitle.innerText = text;
        subtitle.style.opacity = 1;
        setTimeout(() => subtitle.style.opacity = 0, duration);
    }

    // ==========================================
    //           æ¸²æŸ“å¾ªç¯ (ä¼˜åŒ–ç‰ˆ)
    // ==========================================
    function loop() {
        if (!isPlaying) return;
        requestAnimationFrame(loop);
        
        const timeline = Date.now() - startTime;
        
        // è‡ªåŠ¨æ—‹è½¬
        if (!isDragging) {
            if (Math.abs(velocity) > 0.0001) { angleY += velocity; velocity *= 0.95; }
            else { angleY += 0.0015; }
        }

        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width, height);

        const fov = 800;
        const cos = Math.cos(angleY);
        const sin = Math.sin(angleY);
        
        // è®¡ç®—æŠ•å½±
        renderList.forEach(obj => {
            obj.update(timeline);
            const rx = obj.x * cos - obj.z * sin;
            const rz = obj.z * cos + obj.x * sin;
            const scale = fov / (fov + (rz - cameraZ));
            obj.px = width/2 + rx * scale;
            obj.py = height/2 + (obj.y - 50) * scale;
            obj.scale = scale;
            obj.depth = rz;
        });

        // æ’åº (å¿…é¡»ä¿ç•™ï¼Œä¸ºäº†é®æŒ¡å…³ç³»)
        renderList.sort((a, b) => b.depth - a.depth);

        // ç»˜åˆ¶ (å–æ¶ˆå…¨å±€ lighterï¼Œåªå¯¹éƒ¨åˆ†å¯¹è±¡æ‰‹åŠ¨æ¨¡æ‹Ÿå‘å…‰)
        renderList.forEach(obj => {
            if (obj.scale <= 0) return;

            if (obj.type === 'text') {
                if (timeline > 6000) {
                    ctx.save();
                    ctx.font = `bold ${Math.max(10, obj.fontSize * obj.scale)}px sans-serif`;
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillStyle = obj.color;
                    ctx.fillText(obj.text, obj.px, obj.py);
                    ctx.restore();
                }
            } else {
                ctx.beginPath();
                ctx.arc(obj.px, obj.py, obj.size * obj.scale, 0, Math.PI * 2);
                
                // æ€§èƒ½ä¼˜åŒ–å…³é”®ï¼šåªæœ‰ç¯å…‰æ‰ç”¨ shadowBlur
                if (obj.style === 'light') {
                    ctx.shadowBlur = 10 * obj.scale;
                    ctx.shadowColor = obj.color;
                    ctx.fillStyle = obj.color;
                } else if (timeline < 6000) {
                     // æ±‡èšæ—¶ç»™ä¸ªè“è‰²
                     ctx.fillStyle = '#00ffff';
                } else {
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = obj.color;
                }
                ctx.fill();
                ctx.shadowBlur = 0; // é‡ç½®
            }
        });

        drawTopStar(timeline, cos, sin);

        // ç®€åŒ–çš„çƒŸèŠ±é€»è¾‘ (å‡å°‘è®¡ç®—)
        if (timeline > 7000) {
            if (Math.random() < 0.03) fireworks.push(new Firework());
            fireworks.forEach((f, i) => { f.update(); f.draw(); if(f.dead) fireworks.splice(i,1); });
        }
        
        if (timeline > 500 && timeline < 600) showSubtitle("æ˜Ÿæ²³æ±‡èš...", 2000);
        if (timeline > 6000 && timeline < 6100) showSubtitle("åœ£è¯å¿«ä¹ï¼", 2000);
    }

    function drawTopStar(timeline, cos, sin) {
        if (timeline < 6000) return;
        const ty = -750; const rz = 0 * cos + 0 * sin; 
        const fov = 800; const scale = fov / (fov + (rz - cameraZ));
        const px = width/2; const py = height/2 + (ty - 100) * scale;
        
        ctx.save(); ctx.translate(px, py); ctx.rotate(timeline * 0.002);
        ctx.beginPath(); ctx.fillStyle = "#FFD700"; 
        ctx.shadowBlur = 30; ctx.shadowColor = "#FFD700";
        for (let i = 0; i < 5; i++) {
            ctx.lineTo(Math.cos(i*Math.PI/4)*40*scale, -Math.sin(i*Math.PI/4)*40*scale);
            ctx.lineTo(Math.cos((i+0.5)*Math.PI/4)*12*scale, -Math.sin((i+0.5)*Math.PI/4)*12*scale);
        }
        ctx.fill(); ctx.restore(); ctx.shadowBlur = 0;
    }

    class Firework {
        constructor() {
            this.x = Math.random() * width; this.y = height;
            this.ty = height * 0.2 + Math.random() * height * 0.3;
            this.vy = -10 - Math.random() * 5;
            this.color = `hsl(${Math.random()*360},100%,60%)`;
            this.state = 0; this.pt = [];
        }
        update() {
            if (this.state === 0) {
                this.y += this.vy; this.vy += 0.2;
                if (this.vy >= 0 || this.y < this.ty) {
                    this.state = 1;
                    for (let i=0; i<30; i++) { // å‡å°‘çˆ†ç‚¸ç²’å­æ•°
                        const a = Math.random()*Math.PI*2; const s = Math.random()*4+1;
                        this.pt.push({x:this.x, y:this.y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, alpha:1});
                    }
                }
            } else {
                this.pt.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.alpha-=0.03; });
                if (this.pt[0] && this.pt[0].alpha <= 0) this.dead = true;
            }
        }
        draw() {
            ctx.fillStyle = this.color;
            if (this.state === 0) {
                ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill();
            } else {
                this.pt.forEach(p => {
                    ctx.globalAlpha = p.alpha;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1;
            }
        }
    }

    function startShow() {
        if (isPlaying) return;
        isPlaying = true;
        document.getElementById('bgm').play().catch(()=>{});
        startScreen.style.opacity = 0;
        setTimeout(() => startScreen.style.display = 'none', 500);
        init();
        startTime = Date.now();
        loop();
    }
</script>
</body>
</html>
