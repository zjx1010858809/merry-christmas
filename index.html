<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; height: 100%; font-family: sans-serif; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        /* UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* å¯åŠ¨é¡µ */
        #start-screen {
            pointer-events: auto;
            background: #000;
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s;
            position: absolute; top: 0; left: 0; z-index: 200;
        }

        .btn-play {
            padding: 15px 50px;
            font-size: 1.2rem;
            color: #fff;
            background: linear-gradient(to right, #e60073, #ff3300);
            border: none; border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(230, 0, 115, 0.6);
            font-weight: bold; letter-spacing: 2px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* å­—å¹• */
        #subtitle {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            color: #fff; font-size: 1.2rem;
            text-shadow: 0 0 5px #000; opacity: 0; transition: opacity 0.5s;
        }

        /* æœ€ç»ˆæ–‡å­— */
        #final-msg {
            position: absolute; top: 15%; width: 100%; text-align: center;
            opacity: 0; transition: opacity 2s; pointer-events: none; z-index: 300;
        }
        .msg-title {
            font-size: 3rem; color: #FFD700; font-weight: bold; margin-bottom: 10px;
            text-shadow: 0 0 20px #FFD700; font-family: serif;
        }
        .msg-body {
            font-size: 1.3rem; color: #fff; font-weight: bold; text-shadow: 0 2px 4px #000;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="start-screen">
        <button class="btn-play" onclick="startShow()">ğŸ å¼€å¯ç¤¼ç‰©</button>
    </div>
    <div id="subtitle"></div>
    <div id="final-msg">
        <div class="msg-title">Merry Christmas</div>
        <div class="msg-body">è€å©†ï¼Œåœ£è¯å¿«ä¹ â¤ï¸</div>
    </div>
</div>

<canvas id="canvas"></canvas>
<audio id="bgm" loop>
    <source src="https://music.163.com/song/media/outer/url?id=1860000632.mp3" type="audio/mpeg">
</audio>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const subtitle = document.getElementById('subtitle');
    
    let width, height;
    let particles = [];
    let fireworks = [];
    let stars = []; 
    
    let startTime = 0;
    let isPlaying = false;
    
    // æ‰‹æœºç«¯æµç•…çš„ç²’å­æ•°é‡
    const PARTICLE_COUNT = 2800; 
    
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // ==========================================
    //           æ ¸å¿ƒç²’å­ (ä¼˜åŒ–ç‰ˆ)
    // ==========================================
    class Particle {
        constructor() {
            // å†³å®šè§’è‰²ï¼šæ ‘å¹² or æ ‘å† 
            const randType = Math.random();
            this.h = Math.random(); 

            // --- å…³é”®è°ƒæ•´ï¼šæ ‘çš„å¤§å°ä¸ä½ç½® ---
            // åº•éƒ¨Y: 300 (å±å¹•ä¸­ä¸‹æ–¹)
            // é¡¶éƒ¨Y: 300 - 850 = -550 (å‘ä¸Šå»¶ä¼¸850åƒç´ )
            // è¿™æ ·ä¿è¯æ ‘å°–åœ¨å±å¹•å†…ï¼Œä¸”æ ‘è¶³å¤Ÿå¤§
            const baseHeight = 300;
            const treeHeight = 850;

            if (randType < 0.15) {
                // æ ‘å¹²
                this.role = 'trunk';
                this.ty = baseHeight - this.h * (treeHeight * 0.4); // æ ‘å¹²åªå ä¸‹åŠéƒ¨åˆ†
                const maxR = 30 - this.h * 20; 
                const r = maxR * Math.sqrt(Math.random());
                const angle = Math.random() * Math.PI * 2;
                this.tx = Math.cos(angle) * r;
                this.tz = Math.sin(angle) * r;
                this.color = `hsl(${25+Math.random()*10}, 50%, ${20+Math.random()*20}%)`; // æ£•è‰²
                this.size = 2;
            } else {
                // æ ‘å† 
                this.role = 'tree';
                this.ty = baseHeight - 20 - this.h * treeHeight; 

                // å®½åº¦æ§åˆ¶ï¼špow(0.7)è®©åº•éƒ¨æ›´èƒ–ä¸€ç‚¹ï¼Œä¸‰è§’å½¢æ›´æ˜æ˜¾
                const widthFactor = Math.pow(1 - this.h, 0.7);
                // é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢è¶…å‡ºå±å¹•è¾¹ç¼˜
                const maxR = Math.min(width, height) * 0.45 * widthFactor;
                
                const r = maxR * Math.sqrt(Math.random());
                const angle = Math.random() * Math.PI * 2 * 12;
                
                this.tx = Math.cos(angle) * r;
                this.tz = Math.sin(angle) * r;

                // é¢œè‰²
                const subRand = Math.random();
                if (subRand < 0.05) { // æ˜Ÿå…‰
                    this.type = 'star'; this.color = '#fff'; this.size = 2.5; 
                } else if (subRand < 0.2) { // å½©ç¯
                    this.type = 'light'; 
                    this.color = Math.random()>0.5 ? '#FFD700' : `hsl(${Math.random()*360}, 100%, 60%)`;
                    this.size = 3; 
                } else { // å¶å­
                    this.type = 'leaf'; 
                    const l = 20 + this.h * 30; // é¡¶éƒ¨äº®ï¼Œåº•éƒ¨æš—
                    this.color = `hsl(${110+Math.random()*40}, 80%, ${l}%)`; 
                    this.size = 1.8; 
                }
            }

            // åˆå§‹ä½ç½®ï¼šå±å¹•ä¸‹æ–¹éšæœºæ•£å¼€
            const startAngle = Math.random() * Math.PI * 2;
            const startR = 200 + Math.random() * 600;
            this.x = Math.cos(startAngle) * startR;
            this.y = 800; // å±å¹•ä¸‹æ–¹
            this.z = Math.sin(startAngle) * startR;
            
            this.wobble = Math.random() * 100;
        }

        update(timeline) {
            // A: èºæ—‹ä¸Šå‡ (0-8ç§’)
            if (timeline < 8000) {
                const progress = timeline / 8000;
                // å»¶è¿Ÿèµ·é£
                let delay = (1 - this.h) * 0.5; // åº•éƒ¨å…ˆé£
                if (this.role === 'trunk') delay = 0;
                
                let p = (progress - delay) / (1 - delay);
                if (p < 0) p = 0;
                
                // ç¼“åŠ¨
                p = p*p*(3-2*p); 

                if (p > 0) {
                    this.y = 800 + (this.ty - 800) * p;
                    
                    // èºæ—‹æ”¶ç¼©
                    const currentDist = Math.sqrt(this.x*this.x + this.z*this.z);
                    const targetDist = Math.sqrt(this.tx*this.tx + this.tz*this.tz);
                    
                    const r = currentDist + (targetDist - currentDist) * p;
                    
                    // æ—‹è½¬è§’åº¦
                    const originalAngle = Math.atan2(this.z, this.x);
                    const spin = (1-p) * 10; 
                    const angle = originalAngle + spin;
                    
                    this.x = Math.cos(angle) * r;
                    this.z = Math.sin(angle) * r;
                }
            } 
            // B: ç¨³å®šæ˜¾ç¤º (8ç§’+)
            else {
                this.x += (this.tx - this.x) * 0.1;
                this.y += (this.ty - this.y) * 0.1;
                this.z += (this.tz - this.z) * 0.1;

                // å¾®é£æ‘‡æ‘† (å¤§å¹…å‡å¼±ï¼Œåªæ‘‡æ ‘æ¢¢)
                if (timeline > 10000 && this.role === 'tree') {
                    const wind = Math.sin(timeline * 0.002 + this.y * 0.01) * (this.h * 1.5);
                    this.x += wind;
                }
            }

            // --- 3D æŠ•å½±ä¸ç›¸æœº ---
            // ç›¸æœºä½ç½®å›ºå®šï¼Œç¡®ä¿èƒ½çœ‹åˆ°å…¨è²Œ
            // camY=0 (å±…ä¸­), camZ=-1100 (æ‹‰è¿œï¼Œé˜²æ­¢æ ‘é¡¶è¢«åˆ‡)
            const camY = 0; 
            const camZ = -1100; 

            // æ ‘æˆå‹åçš„è‡ªè½¬
            let finalX = this.x;
            let finalZ = this.z;
            if (timeline > 9000) {
                const rot = (timeline - 9000) * 0.0005;
                const cos = Math.cos(rot);
                const sin = Math.sin(rot);
                finalX = this.x * cos - this.z * sin;
                finalZ = this.z * cos + this.x * sin;
            }

            const perspective = 600;
            const scale = perspective / (perspective + finalZ - camZ);
            
            this.px = width/2 + finalX * scale;
            this.py = height/2 + (this.y - camY) * scale;
            this.scale = scale;
        }

        draw(ctx, timeline) {
            if (this.scale <= 0) return;
            
            ctx.beginPath();
            ctx.arc(this.px, this.py, this.size * this.scale, 0, Math.PI * 2);
            
            // èºæ—‹é˜¶æ®µï¼šç»Ÿä¸€ç”¨äº®è‰²ï¼Œåˆ¶é€ æµå…‰æ„Ÿ
            if (timeline < 8000) {
                if (this.role === 'tree') {
                    ctx.fillStyle = `hsl(${180 + timeline*0.01}, 100%, 70%)`; // è“->ç´«å˜åŒ–
                } else {
                    ctx.fillStyle = '#8B4513';
                }
            } 
            // ç¨³å®šé˜¶æ®µï¼šæ˜¾ç¤ºæœ¬è‰²
            else {
                // å½©ç¯é—ªçƒ
                if (this.type === 'light' && timeline > 10000) {
                    const blink = 0.5 + 0.5 * Math.sin(timeline * 0.005 + this.wobble);
                    ctx.globalAlpha = blink;
                    ctx.shadowBlur = 10 * this.scale; // é€‚åº¦å…‰æ™•
                    ctx.shadowColor = this.color;
                    ctx.fillStyle = this.color;
                } else {
                    ctx.globalAlpha = 1;
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = this.color;
                }
            }
            ctx.fill();
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0;
        }
    }

    // é­”æ³•åœ°é¢
    function drawGround(timeline) {
        if (timeline < 1000) return;
        const alpha = Math.min(1, (timeline - 1000) / 4000);
        
        ctx.save();
        ctx.translate(width/2, height/2 + 200); // æ”¾åœ¨æ ‘åº•ä¸‹æ–¹
        ctx.scale(1, 0.25); // å‹æ‰
        
        ctx.rotate(timeline * 0.0005);
        
        // ç®€å•çš„é­”æ³•åœˆ
        ctx.beginPath();
        ctx.arc(0, 0, 350, 0, Math.PI*2);
        ctx.strokeStyle = `rgba(0, 255, 255, ${0.4 * alpha})`;
        ctx.lineWidth = 5;
        ctx.stroke();
        
        ctx.beginPath();
        ctx.arc(0, 0, 280, 0, Math.PI*2);
        ctx.strokeStyle = `rgba(255, 0, 255, ${0.3 * alpha})`;
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.restore();
    }

    // çƒŸèŠ±
    class Firework {
        constructor() {
            this.x = Math.random() * width;
            this.y = height;
            this.targetY = height * 0.15 + Math.random() * height * 0.35;
            this.vy = -10 - Math.random() * 5;
            this.color = `hsl(${Math.random()*360}, 100%, 70%)`;
            this.state = 'rising';
            this.particles = [];
        }
        update() {
            if (this.state === 'rising') {
                this.y += this.vy;
                this.vy += 0.2;
                if (this.vy >= 0 || this.y < this.targetY) this.explode();
            } else {
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.08;
                    p.alpha -= 0.02;
                });
                this.particles = this.particles.filter(p => p.alpha > 0);
                if (this.particles.length === 0) this.state = 'dead';
            }
        }
        explode() {
            this.state = 'exploding';
            for(let i=0; i<60; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 4 + 1;
                this.particles.push({
                    x: this.x, y: this.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    alpha: 1
                });
            }
        }
        draw(ctx) {
            this.particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
                ctx.fillStyle = this.color;
                ctx.globalAlpha = p.alpha;
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }
    }

    // æ ‘é¡¶æ˜Ÿ (ä½ç½®ä¿®æ­£)
    function drawTopStar(timeline) {
        if (timeline < 10000) return;
        const alpha = Math.min(1, (timeline - 10000) / 1000);
        
        // æ ‘é¡¶åæ ‡ï¼šty = baseHeight - treeHeight = 300 - 850 = -550
        const camY = 0; 
        const camZ = -1100;
        const perspective = 600;
        const scale = perspective / (perspective + 0 - camZ); 
        const px = width/2;
        const py = height/2 + (-550 - camY) * scale;

        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(timeline * 0.002);
        ctx.globalAlpha = alpha;
        
        ctx.beginPath();
        ctx.fillStyle = "#FFD700";
        ctx.shadowBlur = 30;
        ctx.shadowColor = "#FFD700";
        for (let i = 0; i < 5; i++) {
            ctx.lineTo(Math.cos((18 + i * 72) * 0.01745) * 40 * scale,
                       -Math.sin((18 + i * 72) * 0.01745) * 40 * scale);
            ctx.lineTo(Math.cos((54 + i * 72) * 0.01745) * 15 * scale,
                       -Math.sin((54 + i * 72) * 0.01745) * 15 * scale);
        }
        ctx.fill();
        ctx.restore();
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
    }

    function showSubtitle(text, duration) {
        subtitle.innerText = text;
        subtitle.style.opacity = 1;
        setTimeout(() => subtitle.style.opacity = 0, duration);
    }

    function loop() {
        if (!isPlaying) return;
        requestAnimationFrame(loop);

        const current = Date.now();
        const timeline = current - startTime;

        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // æ‹–å°¾
        ctx.fillRect(0, 0, width, height);

        drawGround(timeline);

        if (timeline < 15000 && timeline % 2 === 0) {
            particles.sort((a, b) => b.scale - a.scale); 
        }
        particles.forEach(p => { p.update(timeline); p.draw(ctx, timeline); });

        drawTopStar(timeline);

        if (timeline > 12000) {
            if (Math.random() < 0.03) fireworks.push(new Firework());
            fireworks.forEach((f, i) => {
                f.update();
                f.draw(ctx);
                if (f.state === 'dead') fireworks.splice(i, 1);
            });
            if (timeline > 13000) document.getElementById('final-msg').style.opacity = 1;
        }

        if (timeline > 500 && timeline < 600) showSubtitle("å‡†å¤‡å¥½äº†å—...", 2000);
        if (timeline > 4000 && timeline < 4100) showSubtitle("3", 1000);
        if (timeline > 5500 && timeline < 5600) showSubtitle("2", 1000);
        if (timeline > 7000 && timeline < 7100) showSubtitle("1", 1000);
        if (timeline > 8500 && timeline < 8600) showSubtitle("åœ£è¯å¿«ä¹ï¼", 2000);
    }

    function init() {
        particles = [];
        fireworks = [];
        for (let i = 0; i < PARTICLE_COUNT; i++) particles.push(new Particle());
    }

    window.startShow = function() {
        document.getElementById('start-screen').style.opacity = 0;
        setTimeout(() => document.getElementById('start-screen').style.display = 'none', 1000);
        document.getElementById('bgm').play().catch(()=>{});
        init();
        startTime = Date.now();
        isPlaying = true;
        loop();
    }
</script>
</body>
</html>
