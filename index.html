<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas My Love</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; height: 100%; font-family: "Microsoft YaHei", sans-serif; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        /* --- UI å±‚å®¹å™¨ --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* --- 1. å¼€åœºåŠ è½½é¡µ --- */
        #start-screen {
            pointer-events: auto;
            background: radial-gradient(circle, #1a1a2e 0%, #000000 100%);
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1.5s ease-in-out;
            position: absolute; top: 0; left: 0; z-index: 200;
        }

        /* éœ“è™¹æŒ‰é’® */
        .btn-play {
            padding: 18px 50px;
            font-size: 1.3rem;
            color: #00ffff;
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid #00ffff;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: bold;
            transition: all 0.3s;
            opacity: 0.5; pointer-events: none; /* åˆå§‹ä¸å¯ç‚¹ */
        }
        .btn-play.active {
            opacity: 1; pointer-events: auto;
            animation: pulseBtn 2s infinite;
        }
        @keyframes pulseBtn { 0% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.4); } 50% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.8); } 100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.4); } }

        /* åŠ è½½æ¡ */
        .loader-container {
            width: 200px; height: 4px; background: #333; margin-top: 30px; border-radius: 2px; overflow: hidden;
        }
        .loader-bar {
            width: 0%; height: 100%; background: #00ffff; box-shadow: 0 0 10px #00ffff; transition: width 0.1s;
        }
        .loading-text { color: #666; font-size: 12px; margin-top: 10px; letter-spacing: 1px; }

        /* --- 2. ç”µå½±å­—å¹• --- */
        #subtitle {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            color: #fff; font-size: 1.2rem; letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
            opacity: 0; transition: opacity 1.5s; font-weight: 300;
        }

        /* --- 3. æœ€ç»ˆç¥ç¦è¯­ --- */
        #final-msg {
            position: absolute; top: 15%; width: 100%; text-align: center;
            opacity: 0; transition: opacity 3s; pointer-events: none;
        }
        .msg-title {
            font-size: 3rem; color: #FFD700; font-weight: bold; margin-bottom: 20px;
            text-shadow: 0 0 30px #FFD700, 0 0 10px #ff0000;
            font-family: 'Times New Roman', serif;
        }
        .msg-body {
            font-size: 1.3rem; color: #eee; line-height: 2; font-weight: bold;
            text-shadow: 0 2px 5px #000;
        }
    </style>
</head>
<body>

<!-- UI å±‚ -->
<div id="ui-layer">
    <!-- å¼€åœºåŠ è½½ -->
    <div id="start-screen">
        <button class="btn-play" id="start-btn" onclick="startCinematic()">System Loading...</button>
        <div class="loader-container"><div class="loader-bar" id="load-bar"></div></div>
        <div class="loading-text" id="load-text">Initializing Christmas Protocol...</div>
    </div>

    <!-- å­—å¹• -->
    <div id="subtitle"></div>

    <!-- æœ€ç»ˆç¥ç¦ -->
    <div id="final-msg">
        <div class="msg-title">Merry Christmas</div>
        <div class="msg-body">
            äº²çˆ±çš„è€å©†<br>
            æ„¿ä½ çš„ä¸–ç•Œæ°¸è¿œæ˜Ÿæ²³ç’€ç’¨<br>
            æˆ‘çˆ±ä½  â¤ï¸
        </div>
    </div>
</div>

<!-- ç”»å¸ƒ -->
<canvas id="canvas"></canvas>

<!-- èƒŒæ™¯éŸ³ä¹ -->
<audio id="bgm" loop>
    <source src="https://music.163.com/song/media/outer/url?id=1413863371.mp3" type="audio/mpeg">
</audio>

<script>
    // --- ç³»ç»Ÿå˜é‡ ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const subtitle = document.getElementById('subtitle');
    const startBtn = document.getElementById('start-btn');
    const loadBar = document.getElementById('load-bar');
    const loadText = document.getElementById('load-text');
    
    let width, height;
    let particles = [];
    let fireworks = [];
    let stars = []; 
    
    let startTime = 0;
    let isPlaying = false;
    
    const PARTICLE_COUNT = 3200; // ç²’å­æ€»æ•°
    
    // --- å“åº”å¼è°ƒæ•´ ---
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // ==========================================
    //            ç²’å­ç³»ç»Ÿ (æ ¸å¿ƒé€»è¾‘)
    // ==========================================
    class Particle {
        constructor() {
            // 1. è®¾å®šæ ‘çš„ç›®æ ‡å½¢çŠ¶ (Target)
            this.h = Math.random(); // é«˜åº¦ 0-1
            
            // ä½“ç§¯å¡«å……ç®—æ³•: Math.sqrt(Math.random()) è®©ç²’å­å‡åŒ€å¡«å……å†…éƒ¨ï¼Œè€Œä¸æ˜¯åªåœ¨è¡¨é¢
            const maxR = Math.min(width, height) * 0.38;
            const r = (1 - this.h) * maxR * Math.sqrt(Math.random()); 
            const angle = Math.random() * Math.PI * 2 * 12; // 12åœˆèºæ—‹
            
            this.tx = Math.cos(angle) * r; // ç›®æ ‡X
            this.tz = Math.sin(angle) * r; // ç›®æ ‡Z
            this.ty = 250 - this.h * 600;  // ç›®æ ‡Y (æ ‘é«˜)

            // 2. è®¾å®šåˆå§‹çŠ¶æ€ (Initial) -> åœ°é¢é­”æ³•é˜µ
            const floorAngle = Math.random() * Math.PI * 2;
            const floorR = 50 + Math.random() * 450;
            this.x = Math.cos(floorAngle) * floorR;
            this.y = 450; // åœ°é¢ä½ç½®
            this.z = Math.sin(floorAngle) * floorR;

            // 3. å±æ€§
            this.floatOffset = Math.random() * 100;
            
            // 4. ç±»å‹ä¸é¢œè‰²
            const rand = Math.random();
            if (rand < 0.1) { 
                this.type = 'star'; this.color = '#fff'; this.size = 2.5; 
            } else if (rand < 0.25) { 
                this.type = 'light'; 
                this.color = `hsl(${Math.random()*360}, 100%, 65%)`; 
                this.size = 3; 
            } else { 
                this.type = 'leaf'; 
                // ä¸°å¯Œçš„ç»¿è‰²å±‚æ¬¡
                const hue = 100 + Math.random() * 60; // 100-160 (ç»¿åˆ°é’)
                const light = 20 + Math.random() * 40; // äº®åº¦å·®å¼‚
                this.color = `hsl(${hue}, 60%, ${light}%)`; 
                this.size = 1.5; 
            }
        }

        update(timeline) {
            // --- é˜¶æ®µ A: é­”æ³•é˜µæ—‹è½¬ (0 - 7ç§’) ---
            if (timeline < 7000) {
                const rotSpeed = 0.02;
                const dist = Math.sqrt(this.x*this.x + this.z*this.z);
                const angle = Math.atan2(this.z, this.x) + rotSpeed;
                this.x = Math.cos(angle) * dist;
                this.z = Math.sin(angle) * dist;
                // ä¸Šä¸‹æµ®åŠ¨
                this.y = 450 + Math.sin(Date.now()*0.003 + this.floatOffset) * 15;
            }
            
            // --- é˜¶æ®µ B: æ±‡èšå‡ç©º (7 - 16ç§’) ---
            else if (timeline < 16000) {
                // è®¡ç®—å»¶è¿Ÿï¼šåº•éƒ¨(h=0)å…ˆé£ï¼Œé¡¶éƒ¨(h=1)åé£
                const myDelay = (1 - this.h) * 4000; 
                const flyTime = timeline - 7000;
                
                if (flyTime > myDelay) {
                    // ç¼“åŠ¨é£å‘ç›®æ ‡
                    this.x += (this.tx - this.x) * 0.04;
                    this.y += (this.ty - this.y) * 0.04;
                    this.z += (this.tz - this.z) * 0.04;
                }
            }
            
            // --- é˜¶æ®µ C: æ ‘å½¢ç¨³å®š (16ç§’ +) ---
            else {
                // å¼ºåŠ›é”å®šç›®æ ‡
                this.x += (this.tx - this.x) * 0.1;
                this.y += (this.ty - this.y) * 0.1;
                this.z += (this.tz - this.z) * 0.1;
                
                // 18ç§’åå¼€å§‹å‘¼å¸å¾‹åŠ¨
                if (timeline > 18000) {
                    const breath = Math.sin(Date.now()*0.002 + this.y*0.01) * 0.5;
                    this.x += breath; 
                    this.z += breath;
                }
            }

            // --- 3D æŠ•å½±ä¸è¿é•œé€»è¾‘ ---
            let camY = -600; // åˆå§‹ä¿¯è§†
            let camZ = -100; // åˆå§‹è¿‘è·ç¦»
            
            // è¿é•œåŠ¨ç”»
            if (timeline > 6000 && timeline < 16000) {
                const p = (timeline - 6000) / 10000; // 0 -> 1
                camY = -600 + p * 600;  // -600 -> 0 (å¹³è§†)
                camZ = -100 + p * (-700); // -100 -> -800 (æ‹‰è¿œ)
            } else if (timeline >= 16000) {
                camY = 0; camZ = -800;
            }

            // æ•´ä½“æ—‹è½¬ (æ ‘æˆå‹å)
            let finalX = this.x;
            let finalZ = this.z;
            if (timeline > 16000) {
                const rot = (timeline - 16000) * 0.0005;
                const cos = Math.cos(rot);
                const sin = Math.sin(rot);
                finalX = this.x * cos - this.z * sin;
                finalZ = this.z * cos + this.x * sin;
            }

            // æŠ•å½±å…¬å¼
            const perspective = 600;
            const scale = perspective / (perspective + finalZ - camZ);
            
            this.px = width/2 + finalX * scale;
            this.py = height/2 + (this.y - camY) * scale;
            this.scale = scale;
        }

        draw(ctx, timeline) {
            if (this.scale <= 0) return;
            
            ctx.beginPath();
            ctx.arc(this.px, this.py, this.size * this.scale, 0, Math.PI * 2);
            
            // --- ç‚¹ç¯åŠ¨ç”» (18ç§’å¼€å§‹) ---
            if (this.type !== 'leaf' && timeline > 18000) {
                // ä»ä¸‹å¾€ä¸Šäº®
                const lightTime = 18000 + (1 - this.h) * 3000;
                
                if (timeline > lightTime) {
                    ctx.fillStyle = this.color;
                    ctx.shadowBlur = 15 * this.scale;
                    ctx.shadowColor = this.color;
                    // é—ªçƒ
                    const blink = 0.5 + 0.5 * Math.sin(Date.now()*0.005 + this.floatOffset);
                    ctx.globalAlpha = 0.5 + 0.5 * blink;
                } else {
                    ctx.fillStyle = '#112211'; // æœªäº®æ—¶çš„æš—è‰²
                    ctx.globalAlpha = 0.3;
                    ctx.shadowBlur = 0;
                }
            } else {
                // æ ‘å¶
                ctx.fillStyle = this.color;
                // å¼€åœºæ·¡å…¥æ•ˆæœ
                ctx.globalAlpha = Math.min(1, timeline / 2000); 
                ctx.shadowBlur = 0;
            }
            
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    // ==========================================
    //              çƒŸèŠ±ç³»ç»Ÿ
    // ==========================================
    class Firework {
        constructor() {
            this.x = Math.random() * width;
            this.y = height;
            this.targetY = height * 0.15 + Math.random() * height * 0.35;
            this.vy = -10 - Math.random() * 6; // ä¸Šå‡é€Ÿåº¦
            this.color = `hsl(${Math.random()*360}, 100%, 60%)`;
            this.state = 'rising'; // rising, exploding, dead
            this.particles = [];
        }

        update() {
            if (this.state === 'rising') {
                this.y += this.vy;
                this.vy += 0.15; // é‡åŠ›
                if (this.vy >= 0 || this.y < this.targetY) {
                    this.explode();
                }
            } else if (this.state === 'exploding') {
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.08; // ç²’å­é‡åŠ›
                    p.alpha -= 0.015;
                });
                this.particles = this.particles.filter(p => p.alpha > 0);
                if (this.particles.length === 0) this.state = 'dead';
            }
        }

        explode() {
            this.state = 'exploding';
            for (let i = 0; i < 60; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 4 + 1;
                this.particles.push({
                    x: this.x, y: this.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    alpha: 1
                });
            }
        }

        draw(ctx) {
            ctx.globalCompositeOperation = 'lighter'; // å‘å…‰æ··åˆæ¨¡å¼
            if (this.state === 'rising') {
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                // æ‹–å°¾
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x, this.y + 20);
                ctx.strokeStyle = this.color;
                ctx.stroke();
            } else {
                this.particles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 2.5, 0, Math.PI*2);
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                });
            }
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'source-over';
        }
    }

    // ==========================================
    //              èƒŒæ™¯æµæ˜Ÿ
    // ==========================================
    class Star {
        constructor() { this.reset(); }
        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 2;
            this.speed = Math.random() * 0.5 + 0.2;
            this.isShooting = Math.random() < 0.03; // 3%æ¦‚ç‡æµæ˜Ÿ
            if (this.isShooting) {
                this.x = Math.random() * width + 200;
                this.y = -100;
                this.speed = 10 + Math.random() * 10;
            }
        }
        update() {
            if (this.isShooting) {
                this.x -= this.speed;
                this.y += this.speed;
                if (this.x < -100 || this.y > height + 100) this.reset();
            } else {
                this.y -= this.speed; // ç¼“æ…¢ä¸Šå‡
                if (this.y < 0) this.y = height;
            }
        }
        draw(ctx) {
            ctx.fillStyle = this.isShooting ? '#fff' : 'rgba(255,255,255,0.4)';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
            ctx.fill();
        }
    }

    // ==========================================
    //              è¾…åŠ©å‡½æ•°
    // ==========================================
    
    // æ ‘é¡¶å¤§æ˜Ÿç»˜åˆ¶
    function drawTopStar(timeline) {
        if (timeline < 20000) return; // 20ç§’åæ‰æ˜¾ç¤º
        
        const alpha = Math.min(1, (timeline - 20000) / 2000);
        const camZ = -800;
        const perspective = 600;
        const scale = perspective / (perspective + 0 - camZ); // z=0
        const px = width/2;
        const py = height/2 + (-360) * scale; // æ ‘é¡¶åæ ‡

        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(Date.now() * 0.001);
        ctx.globalAlpha = alpha;
        
        ctx.beginPath();
        ctx.fillStyle = "#FFD700";
        ctx.shadowBlur = 40;
        ctx.shadowColor = "#FFD700";
        // ç”»äº”è§’æ˜Ÿ
        for (let i = 0; i < 5; i++) {
            ctx.lineTo(Math.cos((18 + i * 72) * 0.01745) * 30 * scale,
                       -Math.sin((18 + i * 72) * 0.01745) * 30 * scale);
            ctx.lineTo(Math.cos((54 + i * 72) * 0.01745) * 12 * scale,
                       -Math.sin((54 + i * 72) * 0.01745) * 12 * scale);
        }
        ctx.fill();
        ctx.restore();
        ctx.globalAlpha = 1;
        ctx.shadowBlur = 0;
    }

    function showSubtitle(text, duration) {
        subtitle.innerText = text;
        subtitle.style.opacity = 1;
        setTimeout(() => subtitle.style.opacity = 0, duration);
    }

    // ==========================================
    //              ä¸»å¾ªç¯
    // ==========================================
    function loop() {
        if (!isPlaying) return;
        requestAnimationFrame(loop);

        const current = Date.now();
        const timeline = current - startTime;

        // 1. èƒŒæ™¯æ¸…ç©º (å¸¦æ‹–å°¾æ•ˆæœ)
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.fillRect(0, 0, width, height);

        // 2. ç»˜åˆ¶èƒŒæ™¯æ˜Ÿ
        stars.forEach(s => { s.update(); s.draw(ctx); });

        // 3. ç»˜åˆ¶ç²’å­ (æ¯éš”å‡ å¸§æ’åºä¸€æ¬¡ä¼˜åŒ–æ€§èƒ½)
        if (timeline < 22000 && timeline % 5 === 0) {
            particles.sort((a, b) => b.scale - a.scale); 
        }
        particles.forEach(p => { p.update(timeline); p.draw(ctx, timeline); });

        // 4. ç»˜åˆ¶æ ‘é¡¶æ˜Ÿ
        drawTopStar(timeline);

        // 5. çƒŸèŠ± (21ç§’åå¼€å§‹)
        if (timeline > 21000) {
            if (Math.random() < 0.02) fireworks.push(new Firework());
            fireworks.forEach((f, i) => {
                f.update();
                f.draw(ctx);
                if (f.state === 'dead') fireworks.splice(i, 1);
            });
            // æ˜¾ç¤ºæœ€ç»ˆæ–‡å­—
            if (timeline > 22000) {
                document.getElementById('final-msg').style.opacity = 1;
            }
        }

        // --- å­—å¹•å‰§æœ¬ ---
        if (timeline > 1000 && timeline < 1100) showSubtitle("å‡›å†¬æ•£å°½...", 4000);
        if (timeline > 7000 && timeline < 7100) showSubtitle("æ˜Ÿæ²³æ±‡èš...", 4000);
        if (timeline > 13000 && timeline < 13100) showSubtitle("ä¸‡ç‰©ä¸ºä½ ç”Ÿé•¿...", 4000);
        if (timeline > 18000 && timeline < 18100) showSubtitle("æ­¤åˆ»ï¼Œå…‰èŠ’ä¸‡ä¸ˆ...", 4000);
    }

    // ==========================================
    //              åˆå§‹åŒ–ä¸å¯åŠ¨
    // ==========================================
    function init() {
        particles = [];
        stars = [];
        for (let i = 0; i < PARTICLE_COUNT; i++) particles.push(new Particle());
        for (let i = 0; i < 150; i++) stars.push(new Star());
    }

    // æ¨¡æ‹Ÿèµ„æºåŠ è½½
    let progress = 0;
    const loadTimer = setInterval(() => {
        progress += Math.random() * 5;
        if (progress > 100) progress = 100;
        loadBar.style.width = progress + '%';
        if (progress === 100) {
            clearInterval(loadTimer);
            loadText.innerText = "Ready to Launch";
            startBtn.innerText = "ğŸ¬ ç‚¹å‡»æ’­æ”¾ä¸“å±å½±ç‰‡";
            startBtn.classList.add('active');
        }
    }, 50);

    window.startCinematic = function() {
        // éšè—UI
        document.getElementById('start-screen').style.opacity = 0;
        setTimeout(() => document.getElementById('start-screen').style.display = 'none', 1500);
        
        // æ’­æ”¾éŸ³ä¹
        document.getElementById('bgm').play().catch(() => console.log('Music require interaction'));
        
        // å¯åŠ¨é€»è¾‘
        init();
        startTime = Date.now();
        isPlaying = true;
        loop();
    }
</script>
</body>
</html>
